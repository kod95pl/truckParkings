<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Drivers Map – TruckWork</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />

    <style>
      html,
      body,
      #map {
        height: 100%;
        margin: 0;
      }

      .topbar {
        position: absolute;
        z-index: 1000;
        left: 10px;
        top: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 8px 10px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      }

      .topbar button {
        border: 1px solid #ddd;
        padding: 6px 10px;
        border-radius: 8px;
        background: #fff;
        cursor: pointer;
      }

      .topbar input[type="number"] {
        width: 80px;
        padding: 4px 6px;
      }

      /* --- Легенда --- */
      .legend {
        position: absolute;
        left: 10px;
        bottom: 10px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.92);
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        overflow: hidden; /* важно для анимации высоты контента */
      }

      .legend-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        cursor: pointer;
        background: #f5f5f5;
        border-bottom: 1px solid #ddd;
      }

      .legend-header:hover {
        background: #eee;
      }

      #legendToggle {
        font-size: 16px;
        transition: transform 0.3s ease;
      }

      .legend.collapsed #legendToggle {
        transform: rotate(-90deg);
      }

      /* Плавная анимация сворачивания/разворачивания по реальной высоте */
      .legend-content {
        height: auto;           /* конечное открытое состояние */
        opacity: 1;
        overflow: hidden;
        transition: height 0.35s ease, opacity 0.25s ease;
        padding: 10px;
      }
      .legend.collapsed .legend-content {
        height: 0 !important;   /* свернутое состояние */
        opacity: 0;
        padding-top: 0;
        padding-bottom: 0;
      }

      .legend .item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 5px 0;
      }

      .dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        display: inline-block;
        border: 2px solid #333;
      }
      .dot.blue   { background: #89b5ff; border-color: #2b6cff; }
      .dot.green  { background: #b8f7b1; border-color: #2a7a2a; }
      .dot.orange { background: #ffd3a1; border-color: #c76a00; }
      .dot.gray   { background: #e2e2e2; border-color: #666; }
      .dot.red    { background: #ffb3b3; border-color: #d70000; }

      .notice {
        font-size: 12px;
        color: #444;
        margin-top: 6px;
      }

      .footer {
        position: absolute;
        bottom: 10px;
        right: 10px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.92);
        padding: 6px 10px;
        border-radius: 10px;
        font: 12px/1.3 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      }

      .checkboxes {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .checkboxes label {
        display: flex;
        align-items: center;
        gap: 6px;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <div class="topbar">
      <strong>Радиус поиска (км)</strong>
      <input id="radiusKm" type="number" value="50" min="5" max="300" step="5" />
      <div class="checkboxes">
        <label><input type="checkbox" id="cbTruck" checked /> TIR-паркинги</label>
        <label><input type="checkbox" id="cbFuel" checked /> Заправки c парковкой</label>
        <label><input type="checkbox" id="cbMotel" checked /> Мотели/отели</label>
        <label><input type="checkbox" id="cbIndustrial" /> Промзоны</label>
        <label><input type="checkbox" id="cbNoGo" checked /> Красные зоны</label>
      </div>
      <button id="btnLocate">Моё местоположение</button>
      <button id="btnReload">Обновить точки</button>
    </div>

    <div class="legend" id="legend">
      <div class="legend-header" id="legendHeader">
        <strong>Обозначения</strong>
        <span id="legendToggle">▼</span>
      </div>
      <div class="legend-content" id="legendContent">
        <div class="item"><span class="dot blue"></span> TIR-паркинг</div>
        <div class="item"><span class="dot green"></span> Заправка с парковкой</div>
        <div class="item"><span class="dot orange"></span> Мотель / отель</div>
        <div class="item"><span class="dot gray"></span> Промзона</div>
        <div class="item"><span class="dot red"></span> Красная зона (нельзя заезжать)</div>
        <div class="notice">Данные: OpenStreetMap / Overpass</div>
      </div>
    </div>

    <div class="footer">© TruckWork · Карта: © OpenStreetMap contributors</div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
      // --- Base Map ---
      const map = L.map("map", { zoomSnap: 0.5, worldCopyJump: true })
        .setView([52.2297, 21.0122], 5); // fallback: Warsaw

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>',
      }).addTo(map);

      // --- Icons ---
      function circleMarker(color) {
        return L.divIcon({
          className: "custom-marker",
          html: `<span style="display:inline-block;width:16px;height:16px;border-radius:50%;background:${color};border:2px solid #333"></span>`,
          iconSize: [16, 16],
          iconAnchor: [8, 8],
        });
      }

      const ICONS = {
        truck: circleMarker("#89b5ff"),   // blue
        fuel: circleMarker("#b8f7b1"),    // green
        motel: circleMarker("#ffd3a1"),   // orange
        industrial: circleMarker("#e2e2e2") // gray
      };

      // --- Layers ---
      const clusterTruck = L.markerClusterGroup({ disableClusteringAtZoom: 13 });
      const clusterFuel  = L.markerClusterGroup({ disableClusteringAtZoom: 13 });
      const clusterMotel = L.markerClusterGroup({ disableClusteringAtZoom: 13 });
      const industrialLayer = L.layerGroup();
      const noGoLayer = L.geoJSON(null, {
        style: { color: "#d70000", weight: 2, fillColor: "#ff4d4d", fillOpacity: 0.25 }
      });

      clusterTruck.addTo(map);
      clusterFuel.addTo(map);
      clusterMotel.addTo(map);
      industrialLayer.addTo(map);
      noGoLayer.addTo(map);

      // --- User location marker ---
      let userMarker = null;
      let userCircle = null;

      function setUserLocation(lat, lon) {
        if (userMarker) map.removeLayer(userMarker);
        if (userCircle) map.removeLayer(userCircle);

        userMarker = L.marker([lat, lon], { title: "Вы здесь" })
          .addTo(map)
          .bindPopup("Ваше местоположение");

        userCircle = L.circle([lat, lon], { radius: 30, color: "#2b6cff", weight: 2 })
          .addTo(map);
      }

      function locateUser() {
        return new Promise((resolve) => {
          if (!navigator.geolocation) return resolve(null);
          navigator.geolocation.getCurrentPosition(
            (pos) => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
            () => resolve(null),
            { enableHighAccuracy: true, timeout: 8000, maximumAge: 10000 }
          );
        });
      }

      // --- Overpass helpers ---
      const OP_URL = "https://overpass-api.de/api/interpreter";

      function overpassFetch(query) {
        const url = OP_URL + "?data=" + encodeURIComponent(query);
        return fetch(url).then((r) => r.json());
      }

      function toLatLng(el) {
        if (el.type === "node") return [el.lat, el.lon];
        if (el.center) return [el.center.lat, el.center.lon];
        return null;
      }

      function elemName(tags = {}) {
        return tags.name || tags.ref || "Без названия";
      }

      function popupFromTags(tags = {}) {
        const name = elemName(tags);
        const addr = [tags["addr:street"], tags["addr:housenumber"], tags["addr:city"]]
          .filter(Boolean)
          .join(" ");
        const brand   = tags.brand  ? `<div><strong>Бренд:</strong> ${tags.brand}</div>`   : "";
        const phone   = tags.phone  ? `<div><strong>Тел.:</strong> ${tags.phone}</div>`     : "";
        const website = tags.website? `<div><a href="${tags.website}" target="_blank" rel="noopener">Сайт</a></div>`: "";
        return `<div style="min-width:200px"><strong>${name}</strong>${addr?`<div>${addr}</div>`:""}${brand}${phone}${website}</div>`;
      }

      function radiusMeters() {
        const km = parseFloat(document.getElementById("radiusKm").value) || 50;
        return Math.max(5000, Math.min(300000, km * 1000));
      }

      function buildQuery(lat, lon, r) {
        const qTruck = `(
          node["amenity"="parking"]["parking"="truck"](around:${r},${lat},${lon});
          way["amenity"="parking"]["parking"="truck"](around:${r},${lat},${lon});
          relation["amenity"="parking"]["parking"="truck"](around:${r},${lat},${lon});
        );`;

        const qFuel = `(
          node["amenity"="fuel"](around:${r},${lat},${lon});
          way["amenity"="fuel"](around:${r},${lat},${lon});
          relation["amenity"="fuel"](around:${r},${lat},${lon});
        );`;

        const qMotel = `(
          node["tourism"~"^(motel|hotel)$"](around:${r},${lat},${lon});
          way["tourism"~"^(motel|hotel)$"](around:${r},${lat},${lon});
          relation["tourism"~"^(motel|hotel)$"](around:${r},${lat},${lon});
        );`;

        const qIndustrial = `(
          way["landuse"="industrial"](around:${r},${lat},${lon});
          relation["landuse"="industrial"](around:${r},${lat},${lon});
        );`;

        return `
          [out:json][timeout:50];
          (
            ${document.getElementById("cbTruck").checked ? qTruck : ""}
            ${document.getElementById("cbFuel").checked  ? qFuel  : ""}
            ${document.getElementById("cbMotel").checked ? qMotel : ""}
            ${document.getElementById("cbIndustrial").checked ? qIndustrial : ""}
          );
          out center tags;
        `;
      }

      async function loadPOIs(lat, lon) {
        const r = radiusMeters();
        const query = buildQuery(lat, lon, r);

        clusterTruck.clearLayers();
        clusterFuel.clearLayers();
        clusterMotel.clearLayers();
        industrialLayer.clearLayers();

        try {
          const data = await overpassFetch(query);
          const nearbyParkings = []; // для проверки близости к АЗС

          (data.elements || []).forEach((el) => {
            const p = toLatLng(el);
            if (!p) return;
            const tags = el.tags || {};

            if (tags.amenity === "parking" && tags.parking === "truck") {
              const m = L.marker(p, { icon: ICONS.truck }).bindPopup(popupFromTags(tags));
              m.addTo(clusterTruck);
              nearbyParkings.push({ lat: p[0], lon: p[1] });
            } else if (tags.amenity === "fuel") {
              const hasParkingTag = (tags.parking === "yes" || tags["parking:lanes"]);
              const nearTruckParking = nearbyParkings.some(
                (pk) => distanceMeters(p[0], p[1], pk.lat, pk.lon) < 150
              );
              if (hasParkingTag || nearTruckParking) {
                const m = L.marker(p, { icon: ICONS.fuel }).bindPopup(popupFromTags(tags));
                m.addTo(clusterFuel);
              }
            } else if (tags.tourism === "motel" || tags.tourism === "hotel") {
              const m = L.marker(p, { icon: ICONS.motel }).bindPopup(popupFromTags(tags));
              m.addTo(clusterMotel);
            } else if (tags.landuse === "industrial") {
              if (el.geometry) {
                const latlngs = el.geometry.map((g) => [g.lat, g.lon]);
                const poly = L.polygon(latlngs, { color: "#666", weight: 1, fillColor: "#999", fillOpacity: 0.15 });
                poly.bindPopup(popupFromTags(tags));
                poly.addTo(industrialLayer);
              } else {
                L.circle(p, { radius: 80, color: "#666", weight: 1, fillColor: "#999", fillOpacity: 0.15 })
                  .addTo(industrialLayer);
              }
            }
          });
        } catch (err) {
          console.error(err);
          alert("Не удалось загрузить точки из Overpass. Попробуйте уменьшить радиус или повторить позже.");
        }
      }

      // --- No-go zones (красные зоны) ---
      const demoNoGo = {
        type: "FeatureCollection",
        features: [
          {
            type: "Feature",
            properties: { name: "Примерная зона" },
            geometry: {
              type: "Polygon",
              coordinates: [[[21.0, 52.22], [21.02, 52.22], [21.02, 52.24], [21.0, 52.24], [21.0, 52.22]]]
            }
          }
        ]
      };

      function loadNoGo() {
        noGoLayer.clearLayers();
        if (!document.getElementById("cbNoGo").checked) return;
        // Для своего файла: fetch('./no_go_zones.geojson').then(r=>r.json()).then(geo=> noGoLayer.addData(geo));
        noGoLayer.addData(demoNoGo);
      }

      // --- Utils ---
      function distanceMeters(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) ** 2 +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) ** 2;
        return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      }

      // --- UI events ---
      document.getElementById("btnLocate").addEventListener("click", async () => {
        const loc = await locateUser();
        if (loc) {
          setUserLocation(loc.lat, loc.lon);
          map.setView([loc.lat, loc.lon], 11);
        } else {
          alert("Не удалось определить геолокацию в браузере.");
        }
      });

      document.getElementById("btnReload").addEventListener("click", async () => {
        const center = userMarker ? userMarker.getLatLng() : map.getCenter();
        await loadPOIs(center.lat, center.lng);
        loadNoGo();
      });

      document.getElementById("cbTruck").addEventListener("change", () => {
        if (document.getElementById("cbTruck").checked) map.addLayer(clusterTruck);
        else map.removeLayer(clusterTruck);
      });
      document.getElementById("cbFuel").addEventListener("change", () => {
        if (document.getElementById("cbFuel").checked) map.addLayer(clusterFuel);
        else map.removeLayer(clusterFuel);
      });
      document.getElementById("cbMotel").addEventListener("change", () => {
        if (document.getElementById("cbMotel").checked) map.addLayer(clusterMotel);
        else map.removeLayer(clusterMotel);
      });
      document.getElementById("cbIndustrial").addEventListener("change", () => {
        if (document.getElementById("cbIndustrial").checked) map.addLayer(industrialLayer);
        else map.removeLayer(industrialLayer);
      });
      document.getElementById("cbNoGo").addEventListener("change", loadNoGo);

      // --- Init ---
      (async function init() {
        const loc = await locateUser();
        if (loc) {
          setUserLocation(loc.lat, loc.lon);
          map.setView([loc.lat, loc.lon], 11);
        }
        const center = loc ? [loc.lat, loc.lon] : [52.2297, 21.0122];
        await loadPOIs(center[0], center[1]);
        loadNoGo();
      })();

      // --- Toggle legend (плавная анимация высоты) ---
      const legend         = document.getElementById("legend");
      const legendHeader   = document.getElementById("legendHeader");
      const legendContent  = document.getElementById("legendContent");

      function collapseLegend() {
        // 1) фиксируем текущую высоту как старт
        legendContent.style.height = legendContent.scrollHeight + "px";
        // 2) следующий кадр — до 0 + класс
        requestAnimationFrame(() => {
          legend.classList.add("collapsed");
          legendContent.style.height = "0px";
        });
      }

      function expandLegend() {
        // 1) подготовка: высота 0, снимаем класс
        legendContent.style.height = "0px";
        legend.classList.remove("collapsed");
        // 2) следующий кадр — к полной высоте
        requestAnimationFrame(() => {
          legendContent.style.height = legendContent.scrollHeight + "px";
        });
        // 3) очистка inline-стиля после окончания анимации
        const onEnd = (e) => {
          if (e.propertyName === "height") {
            legendContent.style.height = "auto";
            legendContent.removeEventListener("transitionend", onEnd);
          }
        };
        legendContent.addEventListener("transitionend", onEnd);
      }

      legendHeader.addEventListener("click", () => {
        const isCollapsed = legend.classList.contains("collapsed");
        if (isCollapsed) expandLegend();
        else collapseLegend();
      });

      // Стартовое состояние (по желанию можно добавить класс 'collapsed' в HTML)
      window.addEventListener("load", () => {
        if (legend.classList.contains("collapsed")) {
          legendContent.style.height = "0px";
        } else {
          legendContent.style.height = "auto";
        }
      });
    </script>
  </body>
</html>
