<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Truck Drivers Map ‚Äî TruckWork</title>

  <!-- Leaflet + MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html, body { height:100%; margin:0; }
    #map { position:fixed; inset:0; }

    /* ---------- UI ---------- */
    .panel {
      position:absolute; z-index:1000; background:rgba(255,255,255,.96);
      border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.12);
      font:14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      overflow:hidden;
    }
    .panel header {
      display:flex; align-items:center; gap:8px; padding:8px 10px; background:#fff; border-bottom:1px solid #eee;
    }
    .panel .body { padding:10px; }
    .caret { cursor:pointer; margin-left:auto; border:1px solid #ddd; border-radius:8px; padding:4px 8px; background:#fff; }
    .collapsed .body { display:none; }
    .collapsed header { border-bottom:none; }

    .topbar { top:10px; left:50%; transform:translateX(-50%); width:calc(100% - 20px); max-width:1180px; }
    .topbar .body { display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center; }
    .group { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .chip { border:1px solid #ddd; padding:6px 10px; border-radius:999px; background:#fff; user-select:none; }
    .chip input { margin-right:6px; }
    .topbar select, .topbar input[type="number"] { border:1px solid #ddd; border-radius:8px; padding:6px 10px; background:#fff; }

    .legend { left:10px; bottom:10px; min-width:280px; }
    .legend .row { display:flex; align-items:center; gap:8px; margin:6px 0; }
    .legend .hint { margin-top:6px; opacity:.7; font-size:12px; }

    .restrictions { right:10px; bottom:10px; width:340px; max-height:40%; }
    .restrictions .rule { padding:8px; border-left:3px solid #dc3250; background:#fff; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,.06); margin-bottom:8px; }
    .muted { opacity:.7; }

    /* ---------- markers ---------- */
    .dot { width:14px; height:14px; border-radius:50%; display:inline-block; border:2px solid #333; }
    .dot.service{background:#89b5ff;border-color:#2b6cff;}
    .dot.repair{background:#ffd3a1;border-color:#c76a00;}
    .dot.parking{background:#b8f7b1;border-color:#2a7a2a;}
    .dot.fuel{background:#cde1ff;border-color:#3468ff;}
    .dot.roadpt{background:#ffd1d1;border-color:#d22;}

    .pill { display:inline-block; padding:2px 6px; border-radius:999px; font-size:11px; border:1px solid #ccc; background:#fff; }
    .pill.ok{border-color:#2a7a2a;color:#2a7a2a;}
    .pill.warn{border-color:#c76a00;color:#c76a00;}
    .pill.full{border-color:#d22;color:#d22;}

    .toast {
      position:absolute; left:50%; top:78px; transform:translateX(-50%);
      z-index:1200; background:rgba(255,255,255,.96); border:1px solid #eee; border-radius:10px;
      padding:8px 10px; box-shadow:0 2px 10px rgba(0,0,0,.08); font:13px system-ui;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- TOPBAR (collapsible) -->
  <div class="panel topbar" id="panelTop">
    <header>
      <strong>–§–∏–ª—å—Ç—Ä—ã –∏ —Ä–∞–¥–∏—É—Å</strong>
      <button class="caret" id="toggleTop">‚ñ≤</button>
    </header>
    <div class="body">
      <div class="group">
        <strong>–†–∞–¥–∏—É—Å (–∫–º)</strong>
        <input id="radiusKm" type="number" value="50" min="5" max="500" step="5" />
      </div>
      <div class="group">
        <!-- —Ç–≤–æ–∏ –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–µ —Å–ª–æ–∏ -->
        <label class="chip"><input type="checkbox" id="cbService" checked> –°–µ—Ä–≤–∏—Å –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤</label>
        <label class="chip"><input type="checkbox" id="cbRepair" checked> –†–µ–º–æ–Ω—Ç/–º–∞—Å—Ç–µ—Ä—Å–∫–∏–µ</label>

        <!-- MapTrip -->
        <label class="chip"><input type="checkbox" id="cbMTparking" checked> –ü–∞—Ä–∫–∏–Ω–≥–∏ TIR</label>
        <label class="chip"><input type="checkbox" id="cbMTfuel" checked> –ó–∞–ø—Ä–∞–≤–∫–∏</label>
        <select id="fuelType">
          <option value="Diesel" selected>Diesel</option>
          <option value="SuperE5">Super E5</option>
          <option value="SuperE10">Super E10</option>
          <option value="SuperPlus">SuperPlus</option>
          <option value="Autogas">Autogas</option>
        </select>
        <label class="chip"><input type="checkbox" id="cbMTroadPt" checked> –†–∞–±–æ—Ç—ã ‚Äî —Ç–æ—á–∫–∏</label>
        <label class="chip"><input type="checkbox" id="cbMTroadLn" checked> –ª–∏–Ω–∏–∏</label>
      </div>
      <div class="group" style="justify-self:end; opacity:.6">–ö–∞—Ä—Ç–∞: Carto Light</div>
    </div>
  </div>

  <!-- LEGEND (collapsible) -->
  <div class="panel legend" id="panelLegend">
    <header>
      <strong>–õ–µ–≥–µ–Ω–¥–∞</strong>
      <button class="caret" id="toggleLegend">‚ñ≤</button>
    </header>
    <div class="body">
      <div class="row"><span class="dot service"></span>–°–µ—Ä–≤–∏—Å –¥–ª—è –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤</div>
      <div class="row"><span class="dot repair"></span>–†–µ–º–æ–Ω—Ç / –º–∞—Å—Ç–µ—Ä—Å–∫–∏–µ / —à–∏–Ω—ã (HGV)</div>
      <div class="row"><span class="dot parking"></span>–ü–∞—Ä–∫–∏–Ω–≥ TIR (MapTrip)</div>
      <div class="row"><span class="dot fuel"></span>–ó–∞–ø—Ä–∞–≤–∫–∞ (MapTrip)</div>
      <div class="row"><span class="dot roadpt"></span>–î–æ—Ä–æ–∂–Ω—ã–µ —Ä–∞–±–æ—Ç—ã (—Ç–æ—á–∫–∏/–ª–∏–Ω–∏–∏)</div>
      <div class="hint">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –º–∞—Ä–∫–µ—Ä ‚Äî –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏, –∫–æ–Ω—Ç–∞–∫—Ç—ã, —Ü–µ–Ω—ã.</div>
    </div>
  </div>

  <!-- RESTRICTIONS (collapsible, –∫–∞–∫ —Ä–∞–Ω—å—à–µ-–∑–∞–≥–ª—É—à–∫–∞) -->
  <div class="panel restrictions collapsed" id="panelRestr">
    <header>
      <strong>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è (–ø—Ä–∞–≤–∏–ª–∞)</strong>
      <span class="muted" id="countryInfo"></span>
      <button class="caret" id="toggleRestr">‚ñº</button>
    </header>
    <div class="body" id="restrictionsBody">
      <div class="muted">–í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á Trafficban API, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ —Å—Ç—Ä–∞–Ω–µ.</div>
    </div>
  </div>

  <script>
    /* ===================== CONFIG ===================== */
    const MAPTRIP_TOKEN = "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJzMjQ2NzZAcGp3c3RrLmVkdS5wbCIsImF1dGgiOiJST0xFX1VTRVIiLCJpZCI6MjM0MDAzOCwiY29tcGFueUlkIjoyMzQwMTg2LCJleHAiOjE3NjQyMzE2NDZ9.TseoqPIXt3oTM1DBAR80EuueQA53zjXjCDnsoVCfzqf0syAyquSqIwshzBYLyksEQLTIATHqA0SyGAey0dCtxw"; // <--- –í–°–¢–ê–í–¨ –°–í–û–ô –¢–û–ö–ï–ù
    const MAPTRIP_BASE  = "https://api.maptrip.de/v1";
    const MT_HEADERS = (lang="ru,en;q=0.8") => ({
      "accept": "application/json",
      "Accept-Language": lang,
      "Authorization": "Bearer " + MAPTRIP_TOKEN
    });

    // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã (–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –∑–∞–≥–ª—É—à–∫–æ–π)
    const FOURSQUARE_API_KEY = "";
    const GEOAPIFY_API_KEY   = "";

    /* ===================== MAP ===================== */
    const cartoLight = L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
      maxZoom: 20, attribution: "&copy; OpenStreetMap contributors & Carto"
    });
    const map = L.map("map", { zoomSnap: .5, layers:[cartoLight] });

    // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    const stateKey = "truckwork.map.state.v2";
    function loadState(){
      try { return JSON.parse(localStorage.getItem(stateKey) || "{}"); } catch { return {}; }
    }
    function saveState(partial){
      const s = Object.assign(loadState(), partial || {});
      localStorage.setItem(stateKey, JSON.stringify(s));
    }

    // –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ü–µ–Ω—Ç—Ä/–∑—É–º
    (function initMapView(){
      const s = loadState();
      if (s.center && s.zoom) {
        map.setView(s.center, s.zoom);
      } else {
        map.setView([52.23, 21.01], 11);
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            pos => map.setView([pos.coords.latitude, pos.coords.longitude], 12),
            ()=>{},
            { enableHighAccuracy:true, timeout:6000 }
          );
        }
      }
    })();

    setTimeout(()=>map.invalidateSize(), 50);
    window.addEventListener("resize", ()=>map.invalidateSize());

    /* ===================== LAYERS ===================== */
    const iconDot = cls => L.divIcon({ className:"marker", html:`<span class="dot ${cls}"></span>`, iconSize:[16,16], iconAnchor:[8,8] });

    // —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã/—Ä–µ–º–æ–Ω—Ç (OSM)
    const clusterService = L.markerClusterGroup({ disableClusteringAtZoom: 13 });
    const clusterRepair  = L.markerClusterGroup({ disableClusteringAtZoom: 13 });
    map.addLayer(clusterService); map.addLayer(clusterRepair);

    // MapTrip
    const clusterMTparking = L.markerClusterGroup({ disableClusteringAtZoom: 13 });
    const clusterMTfuel    = L.markerClusterGroup({ disableClusteringAtZoom: 13 });
    const mtRoadPt         = L.markerClusterGroup({ disableClusteringAtZoom: 12 });
    const mtRoadLn         = L.geoJSON(null, { style:()=>({ color:"#d22", weight:3, opacity:.9, dashArray:"6,6" }) });
    [clusterMTparking, clusterMTfuel, mtRoadPt, mtRoadLn].forEach(l=>map.addLayer(l));

    /* ===================== UI BINDINGS ===================== */
    const $ = id => document.getElementById(id);
    const elRadius = $("radiusKm");
    const elCbService = $("cbService");
    const elCbRepair  = $("cbRepair");
    const elCbMTparking = $("cbMTparking");
    const elCbMTfuel    = $("cbMTfuel");
    const elFuelType    = $("fuelType");
    const elCbMTroadPt  = $("cbMTroadPt");
    const elCbMTroadLn  = $("cbMTroadLn");
    const elRestrictionsBody = $("restrictionsBody");

    // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    (function applySavedToggles(){
      const s = loadState();
      if (s.radius) elRadius.value = s.radius;
      if (s.filters){
        ["cbService","cbRepair","cbMTparking","cbMTfuel","cbMTroadPt","cbMTroadLn"].forEach(k=>{
          if (k in s.filters) $(k).checked = !!s.filters[k];
        });
      }
      if (s.fuel) elFuelType.value = s.fuel;
      if (s.topCollapsed) togglePanel("panelTop", true);
      if (s.legendCollapsed) togglePanel("panelLegend", true);
      if (s.restrCollapsed) togglePanel("panelRestr", true);
    })();

    function uiRadiusM(){ return Math.min(500000, Math.max(5000, +elRadius.value*1000)); }
    function toast(msg, ms=3000){
      const n = document.createElement("div");
      n.className = "toast"; n.textContent = msg;
      document.body.appendChild(n); setTimeout(()=>n.remove(), ms);
    }

    // collapsible panels
    function togglePanel(id, setCollapsed){
      const p = $(id);
      const collapsed = (setCollapsed !== undefined) ? setCollapsed : !p.classList.contains("collapsed");
      if (collapsed) p.classList.add("collapsed"); else p.classList.remove("collapsed");
    }
    $("toggleTop").onclick    = ()=>{ togglePanel("panelTop");    saveState({ topCollapsed: $("panelTop").classList.contains("collapsed") }); };
    $("toggleLegend").onclick = ()=>{ togglePanel("panelLegend"); saveState({ legendCollapsed: $("panelLegend").classList.contains("collapsed") }); };
    $("toggleRestr").onclick  = ()=>{ togglePanel("panelRestr");  saveState({ restrCollapsed: $("panelRestr").classList.contains("collapsed") }); };

    /* ===================== HELPERS ===================== */
    const seenKeys = new Set(); // –¥–ª—è OSM —Å–µ—Ä–≤–∏—Å–æ–≤/—Ä–µ–º–æ–Ω—Ç–∞
    function seen(lat, lon){
      const key = `${Math.round(lat*10000)}:${Math.round(lon*10000)}`;
      if (seenKeys.has(key)) return true; seenKeys.add(key); return false;
    }
    function popupHTML({name, addr, phone, hours, url}){
      let s = `<b>${name||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"}</b>`;
      if (addr) s += `<div>${addr}</div>`;
      if (phone) s += `<div>üìû ${phone}</div>`;
      if (hours) s += `<div>‚è∞ ${hours}</div>`;
      if (url)   s += `<div><a href="${url}" target="_blank" rel="noopener">–°–∞–π—Ç</a></div>`;
      return s;
    }
    function pillForOccupancy(v){
      if (v==="SPACES_AVAILABLE") return '<span class="pill ok">–º–µ—Å—Ç–∞ –µ—Å—Ç—å</span>';
      if (v==="ALMOST_FULL")      return '<span class="pill warn">–ø–æ—á—Ç–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω</span>';
      if (v==="FULL")             return '<span class="pill full">–ø–æ–ª–æ–Ω</span>';
      return '';
    }
    function bboxParamsFromMap(){
      const b = map.getBounds();
      const sw = b.getSouthWest(), ne = b.getNorthEast();
      return { from:`${sw.lat},${sw.lng}`, to:`${ne.lat},${ne.lng}` };
    }

    // –¥–∏—Ñ—Ñ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ (–±–µ–∑ –º–∏–≥–∞–Ω–∏—è)
    function reconcileMarkers(cluster, dict, items, getId, toLatLng, toIcon, toPopup){
      // mark existing ids
      const nextIds = new Set();
      for (const it of items){
        const id = getId(it);
        if (!id) continue;
        nextIds.add(id);
        const ll = toLatLng(it);
        if (!ll) continue;
        if (dict[id]) {
          // update position/popup if changed
          const m = dict[id];
          const old = m.getLatLng();
          if (old.lat !== ll[0] || old.lng !== ll[1]) m.setLatLng(ll);
          m.setIcon(toIcon(it));
          m.bindPopup(toPopup(it));
        } else {
          const m = L.marker(ll, { icon: toIcon(it) }).bindPopup(toPopup(it));
          dict[id] = m; cluster.addLayer(m);
        }
      }
      // remove disappeared
      for (const id of Object.keys(dict)){
        if (!nextIds.has(id)){
          cluster.removeLayer(dict[id]); delete dict[id];
        }
      }
    }

    /* ===================== LOADERS ===================== */
    async function overpassPOST(query){
      const endpoints = [
        "https://overpass-api.de/api/interpreter",
        "https://overpass.kumi.systems/api/interpreter",
        "https://overpass.nchc.org.tw/api/interpreter",
        "https://overpass.openstreetmap.ru/api/interpreter"
      ];
      for (const ep of endpoints){
        try{
          const r = await fetch(ep, {
            method:"POST",
            headers:{ "Content-Type":"application/x-www-form-urlencoded; charset=UTF-8" },
            body:"data="+encodeURIComponent(query)
          });
          if (r.ok) return await r.json();
        }catch(_){}
      }
      return { elements:[] };
    }
    function toLatLngEl(el){ if(el.type==="node")return[el.lat,el.lon]; if(el.center)return[el.center.lat,el.center.lon]; return null; }

    // OSM —Å–µ—Ä–≤–∏—Å—ã/—Ä–µ–º–æ–Ω—Ç (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
    async function fetchOSMServicesAndRepair(lat, lon, rad){
      const q = `
        [out:json][timeout:50];
        (
          node["service:vehicle:truck"="yes"](around:${rad},${lat},${lon});
          way ["service:vehicle:truck"="yes"](around:${rad},${lat},${lon});
          node["truck:service"="yes"](around:${rad},${lat},${lon});
          way  ["truck:service"="yes"](around:${rad},${lat},${lon});
          node["truck:repair"="yes"](around:${rad},${lat},${lon});
          way  ["truck:repair"="yes"](around:${rad},${lat},${lon});
          node["repair:truck"="yes"](around:${rad},${lat},${lon});
          way  ["repair:truck"="yes"](around:${rad},${lat},${lon});
          node["amenity"="car_repair"](around:${rad},${lat},${lon});
          way  ["amenity"="car_repair"](around:${rad},${lat},${lon});
          node["shop"="car_repair"](around:${rad},${lat},${lon});
          way  ["shop"="car_repair"](around:${rad},${lat},${lon});
          node["shop"="tyres"](around:${rad},${lat},${lon});
          way  ["shop"="tyres"](around:${rad},${lat},${lon});
        ); out center tags;`;
      const data = await overpassPOST(q);
      const list = [];
      (data.elements||[]).forEach(el=>{
        const p = toLatLngEl(el); if(!p) return;
        const [la,lo] = p; if (seen(la,lo)) return;
        const t = el.tags||{};
        const guess = (t["truck:repair"]==="yes" || t["repair:truck"]==="yes" ||
                       /tyre|tire|wulkan|opon/i.test(t.shop||"") ||
                       /repair/i.test(t.amenity||""))
                       ? "repair" : "service";
        list.push({
          id: `osm-${el.type}-${el.id}`,
          name: t.name, lat: la, lon: lo,
          addr: [t["addr:street"], t["addr:housenumber"], t["addr:city"]].filter(Boolean).join(", "),
          phone: t.phone || t["contact:phone"] || null,
          hours: t.opening_hours || null,
          url: t.website || null,
          guess
        });
      });
      return list;
    }

    // OSM roadworks (–≤—Å—è –ï–≤—Ä–æ–ø–∞): long-term + –≤—Ä–µ–º–µ–Ω–Ω—ã–µ (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ)
    async function fetchOSMRoadworks(){
      const b = map.getBounds(); const rad = uiRadiusM();
      const c = map.getCenter();
      const q = `
        [out:json][timeout:50];
        (
          way["highway"="construction"](around:${rad},${c.lat},${c.lng});
          relation["highway"="construction"](around:${rad},${c.lat},${c.lng});
          way["construction"](around:${rad},${c.lat},${c.lng});
          relation["construction"](around:${rad},${c.lat},${c.lng});
          node["highway"="construction"](around:${rad},${c.lat},${c.lng});
        );
        out geom tags;`;
      const data = await overpassPOST(q);
      const lines = [], points = [];
      (data.elements||[]).forEach(el=>{
        if (el.type==="way" || el.type==="relation"){
          const geom = el.geometry || (el.members||[]).map(m=>m.geometry||[]).flat();
          if (geom && geom.length>=2){
            lines.push({
              id: `osmrw-${el.type}-${el.id}`,
              line: geom.map(g=>[g.lat,g.lon]),
              props: { type:"ConstructionWorks", road: el.tags?.ref || el.tags?.name || "", description: el.tags?.note || "" }
            });
          }
        } else if (el.type==="node"){
          points.push({
            id: `osmrwp-${el.id}`,
            ll: [el.lat, el.lon],
            props: { type:"ConstructionWorks", road: el.tags?.ref || el.tags?.name || "", description: el.tags?.note || "" }
          });
        }
      });
      return { lines, points };
    }

    // MapTrip parking
    function mtPopupParking(p){
      const pr = p.properties||{}, addr = pr.address||{};
      const occ = pr.occupancy ? ('<div>'+pillForOccupancy(pr.occupancy)+'</div>') : '';
      const address = [addr.street, addr.zipcode, addr.city].filter(Boolean).join(", ");
      const img = (pr.images && pr.images[0]) ? `<div style="margin-top:6px"><img src="${pr.images[0]}" alt="" style="width:220px;border-radius:8px"/></div>` : "";
      const link = pr.details ? `<div style="margin-top:6px"><a href="${pr.details}" target="_blank" rel="noopener">–ü–æ–¥—Ä–æ–±–Ω–µ–µ / –±—Ä–æ–Ω—å</a></div>` : "";
      const road = pr.road ? `<div>–î–æ—Ä–æ–≥–∞: ${pr.road}</div>` : "";
      const spaces = pr.spaces ? `<div>–ú–µ—Å—Ç: ${pr.spaces}</div>` : "";
      return `<b>${pr.name||"–ü–∞—Ä–∫–∏–Ω–≥"}</b><div>${address}</div>${road}${spaces}${occ}${link}${img}`;
    }
    async function loadMTparking(dict){
      if (!MAPTRIP_TOKEN || !elCbMTparking.checked) { // —Å–∫—Ä—ã—Ç—å –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏
        reconcileMarkers(clusterMTparking, dict, [], x=>x, ()=>null, ()=>null, ()=>"");
        return;
      }
      const {from,to} = bboxParamsFromMap();
      const url = `${MAPTRIP_BASE}/poi/parking/${encodeURIComponent(from)}/${encodeURIComponent(to)}`;
      try{
        const r = await fetch(url, { headers: MT_HEADERS() });
        if (!r.ok){ if (r.status===401||r.status===403) toast("MapTrip: –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞—Ä–∫–æ–≤–∫–∞–º."); return; }
        const gj = await r.json();
        const items = (gj.features||[]).map(f=>{
          const [lon,lat] = f.geometry?.coordinates||[];
          return { id:`mtpark-${f.properties?.provider||""}-${f.properties?.id||f.properties?.name||`${lat},${lon}`}`, lat, lon, f };
        }).filter(x=>x.lat && x.lon);
        reconcileMarkers(
          clusterMTparking, dict, items,
          it=>it.id,
          it=>[it.lat,it.lon],
          ()=>iconDot("parking"),
          it=>mtPopupParking(it.f)
        );
      }catch{ toast("MapTrip: –æ—à–∏–±–∫–∞ –ø–∞—Ä–∫–æ–≤–æ–∫."); }
    }

    // MapTrip fuel
    function mtPopupFuel(p){
      const pr = p.properties||{}, brand = pr.brand ? ` ‚Äî ${pr.brand}` : "";
      const price = pr.price ? `<div><b>–¶–µ–Ω–∞:</b> ‚Ç¨ ${pr.price}</div>` : "";
      return `<b>${pr.name||"–ê–ó–°"}${brand}</b>${price}<div style="opacity:.7">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π</div>`;
    }
    async function loadMTfuel(dict){
      if (!MAPTRIP_TOKEN || !elCbMTfuel.checked) {
        reconcileMarkers(clusterMTfuel, dict, [], x=>x, ()=>null, ()=>null, ()=>"");
        return;
      }
      const {from,to} = bboxParamsFromMap();
      const fuel = elFuelType.value || "Diesel";
      const url = `${MAPTRIP_BASE}/poi/fuelstations/${encodeURIComponent(fuel)}/${encodeURIComponent(from)}/${encodeURIComponent(to)}`;
      try{
        const r = await fetch(url, { headers: MT_HEADERS() });
        if (!r.ok){ if (r.status===401||r.status===403) toast("MapTrip: –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ê–ó–°."); return; }
        const gj = await r.json();
        const items = (gj.features||[]).map(f=>{
          const [lon,lat] = f.geometry?.coordinates||[];
          return { id:`mtfuel-${f.properties?.id||f.properties?.name||`${lat},${lon}`}`, lat, lon, f };
        }).filter(x=>x.lat && x.lon);
        reconcileMarkers(
          clusterMTfuel, dict, items,
          it=>it.id,
          it=>[it.lat,it.lon],
          ()=>iconDot("fuel"),
          it=>mtPopupFuel(it.f)
        );
        // –ø–æ –∫–ª–∏–∫—É ‚Äî –¥–µ—Ç–∞–ª–∏
        clusterMTfuel.eachLayer(m=>{
          m.off("click"); m.on("click", async ()=>{
            const id = (Object.values(dict).find(mm=>mm===m)?._srcFeatureId) || null;
          });
        });
      }catch{ toast("MapTrip: –æ—à–∏–±–∫–∞ –ê–ó–°."); }
    }

    // MapTrip roadworks (DE) + OSM (EU) => –æ–±—â–∏–π —Å–ª–æ–π
    function mtPopupRoadGeneric(pr){
      const dates = [pr.startDate, pr.endDate].filter(Boolean).join(" ‚Üí ");
      const len = pr.length ? `, ~${(pr.length/1000).toFixed(2)} –∫–º` : "";
      const speed = pr.speedLimit ? `, ${pr.speedLimit} –∫–º/—á` : "";
      return `<b>${pr.type||"Road works"} ${pr.road?("‚Äî "+pr.road):""}</b>
              ${pr.startName||pr.start?("<div>"+(pr.startName||pr.start)+" ‚Üí "+(pr.endName||pr.end||"")+"</div>"):""}
              ${dates?("<div>"+dates+len+speed+"</div>"):""}
              ${pr.description?('<div style="margin-top:6px">'+pr.description+'</div>'):""}`;
    }
    async function loadRoadworks(mtDictPts, mtLinesLayer){
      // –æ—á–∏—Å—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–∏—Ñ—Ñ–æ–º: —Ç–æ—á–∫–∏
      const items = [];

      // 1) MapTrip points (DE)
      if (MAPTRIP_TOKEN && (elCbMTroadPt.checked || elCbMTroadLn.checked)) {
        const {from,to} = bboxParamsFromMap();
        if (elCbMTroadPt.checked){
          try{
            const urlPt = `${MAPTRIP_BASE}/poi/roadworks/points/${encodeURIComponent(from)}/${encodeURIComponent(to)}`;
            const r = await fetch(urlPt, { headers: MT_HEADERS() });
            if (r.ok){
              const gj = await r.json();
              (gj.features||[]).forEach(f=>{
                const [lon,lat] = f.geometry?.coordinates||[];
                if (!lat||!lon) return;
                items.push({
                  id:`mt-rwpt-${f.properties?.id||`${lat},${lon}`}`,
                  lat, lon,
                  pr:f.properties||{}
                });
              });
            }
          }catch{}
        }
        if (elCbMTroadLn.checked){
          try{
            const urlLn = `${MAPTRIP_BASE}/poi/roadworks/lines/${encodeURIComponent(from)}/${encodeURIComponent(to)}`;
            const r2 = await fetch(urlLn, { headers: MT_HEADERS() });
            if (r2.ok){
              const gj2 = await r2.json();
              mtRoadLn.clearLayers();
              mtRoadLn.addData(gj2).eachLayer(l=>l.bindPopup(mtPopupRoadGeneric(l.feature.properties||{})));
            }
          }catch{}
        } else {
          mtRoadLn.clearLayers();
        }
      } else {
        mtRoadLn.clearLayers();
      }

      // 2) OSM (–≤—Å—è –ï–≤—Ä–æ–ø–∞)
      try{
        const eu = await fetchOSMRoadworks();
        if (elCbMTroadPt.checked){
          eu.points.forEach(p=>{
            items.push({ id:p.id, lat:p.ll[0], lon:p.ll[1], pr:p.props });
          });
        }
        if (elCbMTroadLn.checked){
          // –¥–æ–±–∞–≤–∏–º –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ª–∏–Ω–∏—è–º
          eu.lines.forEach(l=>{
            const gj = { type:"Feature", geometry:{ type:"LineString", coordinates:l.line.map(ll=>[ll[1],ll[0]]) }, properties:l.props };
            mtRoadLn.addData(gj);
          });
        }
      }catch{}

      // –¥–∏—Ñ—Ñ –ø–æ —Ç–æ—á–∫–∞–º
      reconcileMarkers(
        mtRoadPt, mtDictPts, items,
        it=>it.id,
        it=>[it.lat,it.lon],
        ()=>iconDot("roadpt"),
        it=>mtPopupRoadGeneric(it.pr)
      );
    }

    /* ===================== MASTER LOAD & EVENTS ===================== */
    const dictMTpark = {};  // id -> marker
    const dictMTfuel = {};
    const dictRWpts  = {};

    async function loadAll(){
      saveState({
        center: [map.getCenter().lat, map.getCenter().lng],
        zoom: map.getZoom(),
        radius: elRadius.value,
        fuel: elFuelType.value,
        filters: {
          cbService: elCbService.checked,
          cbRepair:  elCbRepair.checked,
          cbMTparking: elCbMTparking.checked,
          cbMTfuel: elCbMTfuel.checked,
          cbMTroadPt: elCbMTroadPt.checked,
          cbMTroadLn: elCbMTroadLn.checked
        }
      });

      // –æ—á–∏—Å—Ç–∫–∞ —Å–≤–æ–∏—Ö —Å–ª–æ—ë–≤ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (–Ω–µ —Ç—Ä–æ–≥–∞–µ–º MapTrip —Å–ª–æ–≤–∞—Ä–∏)
      clusterService.clearLayers(); clusterRepair.clearLayers(); seenKeys.clear();

      const c = map.getCenter(), rad = uiRadiusM();
      // —Ç–≤–æ–∏ —Å–µ—Ä–≤–∏—Å—ã/—Ä–µ–º–æ–Ω—Ç
      const osmItems = await fetchOSMServicesAndRepair(c.lat, c.lng, rad);
      osmItems.forEach(obj=>{
        const icon = obj.guess==="repair" ? iconDot("repair") : iconDot("service");
        const layer = obj.guess==="repair" ? clusterRepair : clusterService;
        const m = L.marker([obj.lat, obj.lon], { icon }).bindPopup(popupHTML(obj));
        layer.addLayer(m);
      });

      // MapTrip
      await Promise.all([
        loadMTparking(dictMTpark),
        loadMTfuel(dictMTfuel),
        loadRoadworks(dictRWpts, mtRoadLn)
      ]);

      // –≤—ã–∫–ª—é—á–∞—Ç–µ–ª–∏
      if (!elCbService.checked) clusterService.clearLayers();
      if (!elCbRepair.checked)  clusterRepair.clearLayers();
      if (!elCbMTparking.checked) clusterMTparking.clearLayers();
      if (!elCbMTfuel.checked)    clusterMTfuel.clearLayers();
      if (!elCbMTroadPt.checked)  mtRoadPt.clearLayers();
      if (!elCbMTroadLn.checked)  mtRoadLn.clearLayers();
    }

    // –¥–µ–±–∞—É–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏
    let moveTimer=null;
    map.on("moveend zoomend", ()=>{
      if (moveTimer) clearTimeout(moveTimer);
      moveTimer = setTimeout(loadAll, 350);
    });

    // –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    [elRadius, elCbService, elCbRepair, elCbMTparking, elCbMTfuel, elCbMTroadPt, elCbMTroadLn].forEach(el=>{
      el.addEventListener("change", loadAll);
    });
    elFuelType.addEventListener("change", ()=>{ saveState({ fuel: elFuelType.value }); loadMTfuel(dictMTfuel); });

    // –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–¥–≥—Ä—É–∑–∫–∞
    (async ()=>{ await loadAll(); })();

    /* ===================== RESTRICTIONS STUB ===================== */
    const TRAFFICBAN_API_KEY = "";
    async function getCountryByLatLon(lat,lon){
      try{
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
        const j = await r.json();
        return { country: j?.address?.country || "", cc: j?.address?.country_code?.toUpperCase() || "" };
      } catch { return { country:"", cc:"" }; }
    }
    async function loadTrafficBans(){
      const { country } = await getCountryByLatLon(map.getCenter().lat, map.getCenter().lng);
      $("countryInfo").textContent = country ? `‚Äî ${country}` : "";
      if (!TRAFFICBAN_API_KEY){
        elRestrictionsBody.innerHTML = `<div class="muted">–í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á Trafficban API, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ —Å—Ç—Ä–∞–Ω–µ.</div>`;
        return;
      }
    }
    map.on("moveend", ()=>loadTrafficBans());
    loadTrafficBans();
  </script>
</body>
</html>
