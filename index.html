<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Truck Drivers Map — TruckWork</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { position: fixed; inset: 0; }

    .topbar {
      position: absolute; z-index: 1000; top: 10px; left: 50%; transform: translateX(-50%);
      width: calc(100% - 20px); max-width: 1180px;
      background: rgba(255,255,255,.96); padding: 10px 12px; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.12);
      display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center;
      font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .topbar .group { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .topbar .chip { border:1px solid #ddd; padding:6px 10px; border-radius:999px; background:#fff; cursor:pointer; user-select:none; }
    .topbar .chip input { margin-right:6px; }
    .topbar button, .topbar select { border:1px solid #ddd; padding:6px 10px; border-radius:8px; background:#fff; cursor:pointer; }
    .topbar input[type="number"] { width: 84px; padding: 4px 6px; }

    .legend {
      position: absolute; left: 10px; bottom: 10px; z-index: 1000;
      background: rgba(255,255,255,.96); border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.12);
      padding: 10px 12px; font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; min-width: 280px;
    }
    .legend .row { display:flex; align-items:center; gap:8px; margin:6px 0; }
    .legend .hint { margin-top:6px; opacity:.7; font-size:12px; }

    .restrictions {
      position: absolute; right: 10px; bottom: 10px; z-index: 1000; width: 340px;
      max-height: 40%; background: rgba(255,255,255,.96); border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.12);
      overflow: hidden; display:flex; flex-direction: column; font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .restrictions header { padding: 8px 10px; border-bottom: 1px solid #eee; background:#fff; display:flex; align-items:center; gap:8px; }
    .restrictions .body { overflow:auto; padding: 8px 10px; }
    .restrictions .rule { padding:8px 8px; border-left:3px solid #dc3250; background:#fff; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,.06); margin-bottom:8px; }
    .muted { opacity:.7; }

    .dot { width:14px; height:14px; border-radius:50%; display:inline-block; border:2px solid #333; }
    .dot.service{background:#89b5ff;border-color:#2b6cff;}
    .dot.repair{background:#ffd3a1;border-color:#c76a00;}
    .dot.parking{background:#b8f7b1;border-color:#2a7a2a;}
    .dot.fuel{background:#cde1ff;border-color:#3468ff;}
    .dot.roadpt{background:#ffd1d1;border-color:#d22;}
    .pill { display:inline-block; padding:2px 6px; border-radius:999px; font-size:11px; border:1px solid #ccc; background:#fff; }
    .pill.ok{border-color:#2a7a2a;color:#2a7a2a;}
    .pill.warn{border-color:#c76a00;color:#c76a00;}
    .pill.full{border-color:#d22;color:#d22;}

    /* toast */
    .toast {
      position:absolute; left:50%; top:78px; transform:translateX(-50%);
      z-index:1200; background:rgba(255,255,255,.96); border:1px solid #eee; border-radius:10px;
      padding:8px 10px; box-shadow:0 2px 10px rgba(0,0,0,.08); font:13px system-ui;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="topbar">
    <div class="group">
      <strong>Радиус (км)</strong>
      <input id="radiusKm" type="number" value="50" min="5" max="500" step="5" />
    </div>

    <div class="group">
      <!-- твои исходные слои -->
      <label class="chip"><input type="checkbox" id="cbService" checked /> Сервис грузовиков</label>
      <label class="chip"><input type="checkbox" id="cbRepair" checked /> Ремонт/мастерские</label>

      <!-- MapTrip: парковки, заправки, работы -->
      <label class="chip"><input type="checkbox" id="cbMTparking" checked /> Паркинги TIR (MapTrip)</label>
      <label class="chip"><input type="checkbox" id="cbMTfuel" checked /> Заправки (MapTrip)</label>
      <select id="fuelType">
        <option value="Diesel" selected>Diesel</option>
        <option value="SuperE5">Super E5</option>
        <option value="SuperE10">Super E10</option>
        <option value="SuperPlus">SuperPlus</option>
        <option value="Autogas">Autogas</option>
      </select>
      <label class="chip"><input type="checkbox" id="cbMTroadPt" checked /> Дорожные работы — точки</label>
      <label class="chip"><input type="checkbox" id="cbMTroadLn" checked /> линии</label>
    </div>

    <div class="group">
      <button id="btnLocate">Моё местоположение</button>
      <button id="btnReload">Обновить</button>
    </div>
  </div>

  <div class="legend">
    <div class="row"><span class="dot service"></span>Сервис для грузовиков</div>
    <div class="row"><span class="dot repair"></span>Ремонт / мастерские / шины (HGV)</div>
    <div class="row"><span class="dot parking"></span>Паркинг TIR (MapTrip)</div>
    <div class="row"><span class="dot fuel"></span>Заправка (MapTrip)</div>
    <div class="row"><span class="dot roadpt"></span>Дорожные работы (точки/линии)</div>
    <div class="hint">Нажмите на маркер — подробности, телефон, сайт/цены.</div>
  </div>

  <div class="restrictions" id="restrictionsPanel">
    <header>
      <strong>Ограничения движения (правила)</strong>
      <span class="muted" id="countryInfo"></span>
    </header>
    <div class="body" id="restrictionsBody">
      <div class="muted">Вставьте ключ Trafficban API, чтобы отображать реальные правила по стране.</div>
    </div>
  </div>

  <script>
    /* ===================== CONFIG ===================== */
    // MapTrip
    const MAPTRIP_TOKEN = "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJzMjQ2NzZAcGp3c3RrLmVkdS5wbCIsImF1dGgiOiJST0xFX1VTRVIiLCJpZCI6MjM0MDAzOCwiY29tcGFueUlkIjoyMzQwMTg2LCJleHAiOjE3NjQyMzE2NDZ9.TseoqPIXt3oTM1DBAR80EuueQA53zjXjCDnsoVCfzqf0syAyquSqIwshzBYLyksEQLTIATHqA0SyGAey0dCtxw"; // <-- ВСТАВЬ СВОЙ БЕРЕР-ТОКЕН
    const MAPTRIP_BASE  = "https://api.maptrip.de/v1";
    const MT_HEADERS = (lang="ru,en;q=0.8") => ({
      "accept": "application/json",
      "Accept-Language": lang,
      "Authorization": "Bearer " + MAPTRIP_TOKEN
    });

    // Внешние провайдеры (опционально — как было у тебя)
    const FOURSQUARE_API_KEY = "G4IOHLEFEJVKP15H3FPBPGNFYBSDMBLLKN4XFSU24TSH3FH0";
    const GEOAPIFY_API_KEY   = "4ec7d28510a8484d8726a1b462c5f34b";
    const PROVIDERS = { foursquare: !!FOURSQUARE_API_KEY, geoapify: !!GEOAPIFY_API_KEY };

    /* ===================== MAP ===================== */
    const cartoLight = L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
      maxZoom: 20, attribution: "&copy; OpenStreetMap contributors & Carto"
    });
    const map = L.map("map", { zoomSnap: 0.5, layers: [cartoLight] }).setView([52.23, 21.01], 11);
    setTimeout(() => map.invalidateSize(), 50);
    window.addEventListener("resize", () => map.invalidateSize());

    /* ===================== LAYERS ===================== */
    // твои слои
    const iconDot = (cls) => L.divIcon({ className: "marker", html:`<span class="dot ${cls}"></span>`, iconSize:[16,16], iconAnchor:[8,8] });
    const clusterService = L.markerClusterGroup({ disableClusteringAtZoom: 13 });
    const clusterRepair  = L.markerClusterGroup({ disableClusteringAtZoom: 13 });
    map.addLayer(clusterService); map.addLayer(clusterRepair);

    // MapTrip слои
    const clusterMTparking = L.markerClusterGroup({ disableClusteringAtZoom: 13 });
    const clusterMTfuel    = L.markerClusterGroup({ disableClusteringAtZoom: 13 });
    const mtRoadPt         = L.markerClusterGroup({ disableClusteringAtZoom: 12 });
    const mtRoadLn         = L.geoJSON(null, {
      style: f => ({ color:"#d22", weight: 3, opacity: 0.9, dashArray: "6,6" })
    });

    [clusterMTparking, clusterMTfuel, mtRoadPt, mtRoadLn].forEach(l => map.addLayer(l));

    /* ===================== UI ===================== */
    const elRadius = document.getElementById("radiusKm");
    const elCbService = document.getElementById("cbService");
    const elCbRepair  = document.getElementById("cbRepair");
    const elRestrictionsBody = document.getElementById("restrictionsBody");

    const elCbMTparking = document.getElementById("cbMTparking");
    const elCbMTfuel    = document.getElementById("cbMTfuel");
    const elFuelType    = document.getElementById("fuelType");
    const elCbMTroadPt  = document.getElementById("cbMTroadPt");
    const elCbMTroadLn  = document.getElementById("cbMTroadLn");

    const uiRadiusM = () => Math.min(500000, Math.max(5000, +elRadius.value*1000));

    function toast(msg, ms=3200){
      const n = document.createElement('div');
      n.className = 'toast';
      n.innerText = msg;
      document.body.appendChild(n);
      setTimeout(()=>n.remove(), ms);
    }

    /* ===================== HELPERS ===================== */
    function bboxParamsFromMap(){
      const b = map.getBounds();
      const sw = b.getSouthWest(), ne = b.getNorthEast();
      // MapTrip формат: {from}/{to} где from=lat,lon (SW), to=lat,lon (NE)
      return {
        from: `${sw.lat},${sw.lng}`,
        to:   `${ne.lat},${ne.lng}`
      };
    }
    function pillForOccupancy(v){
      if (v==="SPACES_AVAILABLE") return '<span class="pill ok">места есть</span>';
      if (v==="ALMOST_FULL")      return '<span class="pill warn">почти заполнен</span>';
      if (v==="FULL")             return '<span class="pill full">полон</span>';
      return '';
    }

    /* ===================== YOUR ORIGINAL LOADERS (OSM etc.) ===================== */
    // (укороченные версии, оставляем как есть — они работают параллельно с MapTrip)
    const seenKeys = new Set();
    function seen(lat, lon) {
      const key = `${Math.round(lat*10000)}:${Math.round(lon*10000)}`;
      if (seenKeys.has(key)) return true; seenKeys.add(key); return false;
    }
    function popupHTML({name, addr, phone, hours, url}) {
      let s = `<b>${name || "Без названия"}</b>`;
      if (addr) s += `<div>${addr}</div>`;
      if (phone) s += `<div>📞 ${phone}</div>`;
      if (hours) s += `<div>⏰ ${hours}</div>`;
      if (url)   s += `<div><a href="${url}" target="_blank" rel="noopener">Сайт</a></div>`;
      return s;
    }
    function addMarker(obj){
      if (!obj.lat || !obj.lon) return;
      const repairHit = /repair|tire|tyre|wulkan|opon|шины|сервис\s*tir|truck/i.test(
        [obj.guess, obj.name, obj.hours].filter(Boolean).join(" ")
      );
      const icon = repairHit ? iconDot("repair") : iconDot("service");
      const layer = repairHit ? clusterRepair : clusterService;
      const m = L.marker([obj.lat, obj.lon], { icon }).bindPopup(
        popupHTML({ name: obj.name, addr: obj.addr, phone: obj.phone, hours: obj.hours, url: obj.url })
      );
      layer.addLayer(m);
    }

    async function overpassPOST(query){
      const endpoints = [
        "https://overpass-api.de/api/interpreter",
        "https://overpass.kumi.systems/api/interpreter",
        "https://overpass.nchc.org.tw/api/interpreter",
        "https://overpass.openstreetmap.ru/api/interpreter"
      ];
      for (const ep of endpoints){
        try{
          const r = await fetch(ep, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8" },
            body: "data=" + encodeURIComponent(query)
          });
          if (r.ok) return await r.json();
        }catch(_){}
      }
      return { elements: [] };
    }
    function toLatLng(el){ if(el.type==="node")return[el.lat,el.lon]; if(el.center)return[el.center.lat,el.center.lon]; return null; }

    async function fetchOSM(lat, lon, rad){
      const q = `
        [out:json][timeout:50];
        (
          node["service:vehicle:truck"="yes"](around:${rad},${lat},${lon});
          way ["service:vehicle:truck"="yes"](around:${rad},${lat},${lon});
          node["truck:service"="yes"](around:${rad},${lat},${lon});
          way  ["truck:service"="yes"](around:${rad},${lat},${lon});
          node["truck:repair"="yes"](around:${rad},${lat},${lon});
          way  ["truck:repair"="yes"](around:${rad},${lat},${lon});
          node["repair:truck"="yes"](around:${rad},${lat},${lon});
          way  ["repair:truck"="yes"](around:${rad},${lat},${lon});
          node["amenity"="car_repair"](around:${rad},${lat},${lon});
          way  ["amenity"="car_repair"](around:${rad},${lat},${lon});
          node["shop"="car_repair"](around:${rad},${lat},${lon});
          way  ["shop"="car_repair"](around:${rad},${lat},${lon});
          node["shop"="tyres"](around:${rad},${lat},${lon});
          way  ["shop"="tyres"](around:${rad},${lat},${lon});
          node["amenity"="service_station"](around:${rad},${lat},${lon});
          way  ["amenity"="service_station"](around:${rad},${lat},${lon});
          node["amenity"="vehicle_inspection"](around:${rad},${lat},${lon});
          way  ["amenity"="vehicle_inspection"](around:${rad},${lat},${lon});
          node["name"~"tir|truck|hgv|ciezar|ciężar|wulkan|opon", i](around:${rad},${lat},${lon});
          way  ["name"~"tir|truck|hgv|ciezar|ciężар|wulkan|opon", i](around:${rad},${lat},${lon});
          node[~"^(truck:|hgv:|lorry:).*$"~"."](around:${rad},${lat},${lon});
          way  [~"^(truck:|hgv:|lorry:).*$"~"."](around:${rad},${lat},${lon});
        ); out center tags;`;
      const data = await overpassPOST(q);
      const out = [];
      (data.elements||[]).forEach(el=>{
        const p = toLatLng(el); if(!p) return;
        const [la, lo] = p; if (seen(la, lo)) return;
        const t = el.tags||{};
        const guess = (t["truck:repair"]==="yes" || t["repair:truck"]==="yes" ||
                      /tyre|tire|wulkan|opon/i.test(t.shop||"") ||
                      /repair/i.test(t.amenity||"") ||
                      /tir|truck|hgv|ciezar|ciężар|wulkan|opon/i.test(t.name||""))
                      ? "repair" : "service";
        out.push({
          name: t.name, lat: la, lon: lo,
          addr: [t["addr:street"], t["addr:housenumber"], t["addr:city"]].filter(Boolean).join(" "),
          phone: t.phone || t["contact:phone"] || null,
          hours: t.opening_hours || null,
          url: t.website || null,
          guess
        });
      });
      return out;
    }

    // внешние провайдеры (как раньше)
    async function fetchFoursquare(lat, lon, rad) { /* ... опционально, как у тебя было ... */ return []; }
    async function fetchGeoapify(lat, lon, rad)   { /* ... опционально, как у тебя было ... */ return []; }

    async function loadExternalProviders(lat, lon, rad) {
      const batches = await Promise.allSettled([
        fetchFoursquare(lat, lon, rad),
        fetchGeoapify(lat, lon, rad)
      ]);
      return batches.map(b => b.status==="fulfilled" ? b.value : []).flat();
    }

    /* ===================== MAPTRIP LOADERS ===================== */
    function mtPopupParking(p){
      const pr = p.properties||{}, addr = pr.address||{};
      const occ = pr.occupancy ? ('<div>' + pillForOccupancy(pr.occupancy) + '</div>') : '';
      const address = [addr.street, addr.zipcode, addr.city].filter(Boolean).join(", ");
      const img = (pr.images && pr.images[0]) ? `<div style="margin-top:6px"><img src="${pr.images[0]}" alt="" style="width:220px;border-radius:8px"/></div>` : "";
      const link = pr.details ? `<div style="margin-top:6px"><a href="${pr.details}" target="_blank" rel="noopener">Подробнее / бронь</a></div>` : "";
      const road = pr.road ? `<div>Дорога: ${pr.road}</div>` : "";
      const spaces = pr.spaces ? `<div>Мест: ${pr.spaces}</div>` : "";
      return `<b>${pr.name||"Паркинг"}</b>
              <div>${address}</div>
              ${road}${spaces}${occ}${link}${img}`;
    }

    async function loadMTparking(){
      clusterMTparking.clearLayers();
      if (!elCbMTparking.checked || !MAPTRIP_TOKEN) return;

      const {from, to} = bboxParamsFromMap();
      const url = `${MAPTRIP_BASE}/poi/parking/${encodeURIComponent(from)}/${encodeURIComponent(to)}`;
      try{
        const r = await fetch(url, { headers: MT_HEADERS() });
        if (!r.ok) {
          if (r.status===401 || r.status===403) toast("MapTrip: нет доступа к парковкам (лицензия/токен).");
          return;
        }
        const gj = await r.json();
        (gj.features||[]).forEach(f=>{
          const [lon, lat] = f.geometry?.coordinates || [];
          if (!lat || !lon) return;
          const m = L.marker([lat, lon], { icon: iconDot("parking") }).bindPopup(mtPopupParking(f));
          clusterMTparking.addLayer(m);
        });
      }catch{ toast("MapTrip: ошибка загрузки парковок."); }
    }

    function mtPopupFuel(p){
      const pr = p.properties||{};
      const brand = pr.brand ? ` — ${pr.brand}` : "";
      const price = pr.price ? `<div><b>Цена:</b> € ${pr.price}</div>` : "";
      return `<b>${pr.name||"АЗС"}${brand}</b>${price}<div style="opacity:.7">Нажмите для деталей</div>`;
    }

    async function loadMTfuel(){
      clusterMTfuel.clearLayers();
      if (!elCbMTfuel.checked || !MAPTRIP_TOKEN) return;

      const {from, to} = bboxParamsFromMap();
      const fuel = elFuelType.value || "Diesel";
      const url = `${MAPTRIP_BASE}/poi/fuelstations/${encodeURIComponent(fuel)}/${encodeURIComponent(from)}/${encodeURIComponent(to)}`;
      try{
        const r = await fetch(url, { headers: MT_HEADERS() });
        if (!r.ok) {
          if (r.status===401 || r.status===403) toast("MapTrip: нет доступа к АЗС (лицензия/токен).");
          return;
        }
        const gj = await r.json();
        (gj.features||[]).forEach(f=>{
          const [lon, lat] = f.geometry?.coordinates || [];
          if (!lat || !lon) return;
          const m = L.marker([lat, lon], { icon: iconDot("fuel") })
            .bindPopup(mtPopupFuel(f))
            .on("click", async ()=>{
              // подгружаем детали станции по id
              const id = f.properties?.id;
              if (!id) return;
              try{
                const r2 = await fetch(`${MAPTRIP_BASE}/poi/fuelstations/${encodeURIComponent(id)}`, { headers: MT_HEADERS() });
                if (!r2.ok) return;
                const d = await r2.json();
                const addr = d.address ? [d.address.street, d.address.zipcode, d.address.city].filter(Boolean).join(", ") : "";
                const hours = (d.openingHours||[]).join("<br>");
                const services = (d.services||[]).join(", ");
                const prices = (d.prices||[]).map(p => `${p.fuelType}: € ${p.price}`).join("<br>");
                m.setPopupContent(
                  `<b>${d.name||"АЗС"}${d.brand?(' — '+d.brand):''}</b>
                   <div>${addr}</div>
                   ${hours?('<div style="margin-top:6px">⏰ '+hours+'</div>'):''}
                   ${services?('<div style="margin-top:6px">Услуги: '+services+'</div>'):''}
                   ${prices?('<div style="margin-top:6px">Цены:<br>'+prices+'</div>'):''}`
                ).openPopup();
              }catch{}
            });
          clusterMTfuel.addLayer(m);
        });
      }catch{ toast("MapTrip: ошибка загрузки АЗС."); }
    }

    function mtPopupRoad(p){
      const pr = p.properties||{};
      const dates = [pr.startDate, pr.endDate].filter(Boolean).join(" → ");
      const len = pr.length ? `, ~${(pr.length/1000).toFixed(2)} км` : "";
      const speed = pr.speedLimit ? `, ${pr.speedLimit} км/ч` : "";
      return `<b>${pr.type||"Road works"} — ${pr.road||""}</b>
              <div>${pr.startName||""} → ${pr.endName||""}</div>
              <div>${dates}${len}${speed}</div>
              ${pr.description?('<div style="margin-top:6px">'+pr.description+'</div>'):''}`;
    }

    async function loadMTroadworks(){
      mtRoadPt.clearLayers(); mtRoadLn.clearLayers();
      if (!MAPTRIP_TOKEN) return;
      const {from, to} = bboxParamsFromMap();

      if (elCbMTroadPt.checked){
        try{
          const urlPt = `${MAPTRIP_BASE}/poi/roadworks/points/${encodeURIComponent(from)}/${encodeURIComponent(to)}`;
          const r = await fetch(urlPt, { headers: MT_HEADERS("ru,en;q=0.8") });
          if (!r.ok){ if (r.status===401||r.status===403) toast("MapTrip: нет доступа к дорожным работам."); }
          else{
            const gj = await r.json();
            (gj.features||[]).forEach(f=>{
              const [lon, lat] = f.geometry?.coordinates || [];
              if (!lat || !lon) return;
              const m = L.marker([lat, lon], { icon: iconDot("roadpt") }).bindPopup(mtPopupRoad(f));
              mtRoadPt.addLayer(m);
            });
          }
        }catch{ toast("MapTrip: ошибка загрузки работ (точки)."); }
      }

      if (elCbMTroadLn.checked){
        try{
          const urlLn = `${MAPTRIP_BASE}/poi/roadworks/lines/${encodeURIComponent(from)}/${encodeURIComponent(to)}`;
          const r2 = await fetch(urlLn, { headers: MT_HEADERS("ru,en;q=0.8") });
          if (r2.ok){
            const gj2 = await r2.json();
            mtRoadLn.addData(gj2).eachLayer(l=>{
              l.bindPopup(mtPopupRoad(l.feature));
            });
          }
        }catch{ toast("MapTrip: ошибка загрузки работ (линии)."); }
      }
    }

    /* ===================== TRAFFIC BANS (заглушка как было) ===================== */
    const TRAFFICBAN_API_KEY = "";
    async function getCountryByLatLon(lat,lon){
      try{
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
        const j = await r.json();
        return { country: j?.address?.country || "", cc: j?.address?.country_code?.toUpperCase() || "" };
      } catch { return { country:"", cc:"" }; }
    }
    async function loadTrafficBans(lat,lon){
      elRestrictionsBody.innerHTML = `<div class="muted">Загрузка ограничений…</div>`;
      const { country } = await getCountryByLatLon(lat,lon);
      document.getElementById("countryInfo").textContent = country ? `— ${country}` : "";
      if(!TRAFFICBAN_API_KEY){
        elRestrictionsBody.innerHTML = `<div class="muted">Вставьте ключ Trafficban API, чтобы отображать реальные правила по стране.</div>`;
        return;
      }
      // тут можно подключить реальный Trafficban
    }

    /* ===================== MASTER LOAD ===================== */
    function showEmptyNotice(){
      const old = document.getElementById('emptyNotice'); if (old) old.remove();
      const empty =
        clusterService.getLayers().length===0 &&
        clusterRepair.getLayers().length===0 &&
        clusterMTparking.getLayers().length===0 &&
        clusterMTfuel.getLayers().length===0 &&
        mtRoadPt.getLayers().length===0 &&
        mtRoadLn.getLayers().length===0;
      if (empty) {
        const n = document.createElement('div');
        n.id = 'emptyNotice';
        n.className = 'toast';
        n.innerHTML = 'В этом радиусе точки не найдены. Увеличьте радиус или переместите карту.';
        document.body.appendChild(n);
        setTimeout(()=>n.remove(), 3500);
      }
    }

    async function loadAll(lat,lon){
      // очистка своих слоёв
      clusterService.clearLayers(); clusterRepair.clearLayers(); seenKeys.clear();

      const rad = uiRadiusM();
      const [exts, osm] = await Promise.all([
        loadExternalProviders(lat, lon, rad),
        fetchOSM(lat, lon, rad)
      ]);
      [...exts, ...osm].forEach(addMarker);

      // MapTrip слои
      await Promise.all([
        loadMTparking(),
        loadMTfuel(),
        loadMTroadworks()
      ]);

      // выключатели
      if (!elCbService.checked) clusterService.clearLayers();
      if (!elCbRepair.checked)  clusterRepair.clearLayers();
      if (!elCbMTparking.checked) clusterMTparking.clearLayers();
      if (!elCbMTfuel.checked)    clusterMTfuel.clearLayers();
      if (!elCbMTroadPt.checked)  mtRoadPt.clearLayers();
      if (!elCbMTroadLn.checked)  mtRoadLn.clearLayers();

      await loadTrafficBans(lat,lon);
      showEmptyNotice();
    }

    /* ===================== GEO/CONTROLS ===================== */
    async function locateUser(){
      if(!navigator.geolocation) return null;
      return new Promise(res=>{
        navigator.geolocation.getCurrentPosition(
          pos=>res({lat:pos.coords.latitude, lon:pos.coords.longitude}),
          ()=>res(null),
          { enableHighAccuracy:true, timeout:8000 }
        );
      });
    }
    document.getElementById("btnLocate").onclick = async ()=>{
      const loc = await locateUser();
      if(loc){ map.setView([loc.lat, loc.lon], 11); await loadAll(loc.lat, loc.lon); }
      else alert("Не удалось определить геолокацию");
    };
    document.getElementById("btnReload").onclick = async ()=>{
      const c = map.getCenter(); await loadAll(c.lat, c.lng);
    };
    [elCbService, elCbRepair, elCbMTparking, elCbMTfuel, elCbMTroadPt, elCbMTroadLn].forEach(cb=>{
      cb.addEventListener("change", async ()=>{
        const c = map.getCenter(); await loadAll(c.lat, c.lng);
      });
    });
    elFuelType.addEventListener("change", async ()=>{
      const c = map.getCenter(); await loadMTfuel();
    });
    elRadius.addEventListener("change", async ()=>{
      const c = map.getCenter(); await loadAll(c.lat, c.lng);
    });

    let mtTimer=null;
    map.on("moveend", ()=>{
      if(mtTimer) clearTimeout(mtTimer);
      mtTimer = setTimeout(async ()=>{
        const c = map.getCenter(); await loadAll(c.lat, c.lng);
      }, 400);
    });

    // старт
    (async ()=>{
      const c = map.getCenter();
      await loadAll(c.lat, c.lng);
    })();
  </script>
</body>
</html>
