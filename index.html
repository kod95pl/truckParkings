<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Drivers Map ‚Äì TruckWork</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />

    <style>
      html, body, #map { height: 100%; margin: 0; }

      /* ===== TOPBAR ===== */
      .topbar {
        position: absolute;
        z-index: 1000;
        top: 10px; left: 50%; transform: translateX(-50%);
        width: calc(100% - 20px); max-width: 980px;
        background: rgba(255, 255, 255, 0.9);
        padding: 8px 10px; border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex; gap: 8px; flex-wrap: wrap; align-items: center;
        font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      }
      .topbar button { border: 1px solid #ddd; padding: 6px 10px; border-radius: 8px; background: #fff; cursor: pointer; }
      .topbar input[type="number"] { width: 80px; padding: 4px 6px; }

      /* ===== LEGEND ===== */
      .legend {
        position: absolute; left: 10px; bottom: 10px; z-index: 1000;
        background: rgba(255, 255, 255, 0.92); border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        overflow: hidden;
      }
      .legend-header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 10px; cursor: pointer; background: #f5f5f5; border-bottom: 1px solid #ddd;
      }
      .legend-header:hover { background: #eee; }
      #legendToggle { font-size: 16px; transition: transform 0.3s ease; }
      .legend.collapsed #legendToggle { transform: rotate(-90deg); }
      .legend-content {
        height: auto; opacity: 1; overflow: hidden;
        transition: height 0.35s ease, opacity 0.25s ease;
        padding: 10px;
      }
      .legend.collapsed .legend-content { height: 0 !important; opacity: 0; padding-top: 0; padding-bottom: 0; }

      .legend .item { display: flex; align-items: center; gap: 8px; margin: 5px 0; }
      .dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; border: 2px solid #333; }
      .dot.blue{background:#89b5ff;border-color:#2b6cff;}
      .dot.green{background:#b8f7b1;border-color:#2a7a2a;}
      .dot.orange{background:#ffd3a1;border-color:#c76a00;}
      .dot.gray{background:#e2e2e2;border-color:#666;}
      .dot.red{background:#ffb3b3;border-color:#d70000;}
    </style>
  </head>

  <body>
    <div id="map"></div>

    <!-- TOPBAR -->
    <div class="topbar">
      <strong>–†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞ (–∫–º)</strong>
      <input id="radiusKm" type="number" value="50" min="5" max="300" step="5" />
      <div class="checkboxes" style="display:flex;gap:10px;flex-wrap:wrap;">
        <label><input type="checkbox" id="cbTruck" checked /> TIR-–ø–∞—Ä–∫–∏–Ω–≥–∏</label>
        <label><input type="checkbox" id="cbFuel" checked /> –ó–∞–ø—Ä–∞–≤–∫–∏ c –ø–∞—Ä–∫–æ–≤–∫–æ–π/–¥—É—à–µ–º</label>
        <label><input type="checkbox" id="cbMotel" checked /> –ú–æ—Ç–µ–ª–∏/–æ—Ç–µ–ª–∏</label>
        <label><input type="checkbox" id="cbIndustrial" /> –ü—Ä–æ–º–∑–æ–Ω—ã</label>
        <label><input type="checkbox" id="cbNoGo" checked /> –ö—Ä–∞—Å–Ω—ã–µ –∑–æ–Ω—ã (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤)</label>
      </div>
      <button id="btnLocate">–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
      <button id="btnReload">–û–±–Ω–æ–≤–∏—Ç—å —Ç–æ—á–∫–∏</button>
    </div>

    <!-- –õ–ï–ì–ï–ù–î–ê -->
    <div class="legend" id="legend">
      <div class="legend-header" id="legendHeader">
        <strong>–û–±–æ–∑–Ω–∞—á–µ–Ω–∏—è</strong>
        <span id="legendToggle">‚ñº</span>
      </div>
      <div class="legend-content" id="legendContent">
        <div class="item"><span class="dot blue"></span> TIR-–ø–∞—Ä–∫–∏–Ω–≥</div>
        <div class="item"><span class="dot green"></span> –ó–∞–ø—Ä–∞–≤–∫–∞ (–ø–∞—Ä–∫–æ–≤–∫–∞/–¥—É—à)</div>
        <div class="item"><span class="dot orange"></span> –ú–æ—Ç–µ–ª—å / –æ—Ç–µ–ª—å</div>
        <div class="item"><span class="dot gray"></span> –ü—Ä–æ–º–∑–æ–Ω–∞</div>
        <div class="item"><span class="dot red"></span> –ö—Ä–∞—Å–Ω—ã–µ –∑–æ–Ω—ã (–Ω–µ–ª—å–∑—è/–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ)</div>
      </div>
    </div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
      // --- Base Map ---
      const map = L.map("map", { zoomSnap: 0.5, worldCopyJump: true })
        .setView([52.2297, 21.0122], 5);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>',
      }).addTo(map);

      // --- Icons ---
      function circleMarker(color) {
        return L.divIcon({
          className: "custom-marker",
          html: `<span style="display:inline-block;width:16px;height:16px;border-radius:50%;background:${color};border:2px solid #333"></span>`,
          iconSize: [16, 16], iconAnchor: [8, 8],
        });
      }
      const ICONS = {
        truck: circleMarker("#89b5ff"),
        fuel: circleMarker("#b8f7b1"),
        motel: circleMarker("#ffd3a1"),
        industrial: circleMarker("#e2e2e2"),
      };

      // --- Layers ---
      const clusterTruck = L.markerClusterGroup({ disableClusteringAtZoom: 13 });
      const clusterFuel  = L.markerClusterGroup({ disableClusteringAtZoom: 13 });
      const clusterMotel = L.markerClusterGroup({ disableClusteringAtZoom: 13 });
      const industrialLayer = L.layerGroup();
      const noGoLayer = L.layerGroup(); // —Ç–µ–ø–µ—Ä—å —Ä–∏—Å—É–µ–º –ª–∏–Ω–∏–∏/–ø–æ–ª–∏–≥–æ–Ω—ã

      clusterTruck.addTo(map);
      clusterFuel.addTo(map);
      clusterMotel.addTo(map);
      industrialLayer.addTo(map);
      noGoLayer.addTo(map);

      // --- User location ---
      let userMarker = null; let userCircle = null;
      function setUserLocation(lat, lon) {
        if (userMarker) map.removeLayer(userMarker);
        if (userCircle) map.removeLayer(userCircle);
        userMarker = L.marker([lat, lon], { title: "–í—ã –∑–¥–µ—Å—å" }).addTo(map).bindPopup("–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ");
        userCircle = L.circle([lat, lon], { radius: 30, color: "#2b6cff", weight: 2 }).addTo(map);
      }
      function locateUser() {
        return new Promise((resolve) => {
          if (!navigator.geolocation) return resolve(null);
          navigator.geolocation.getCurrentPosition(
            (pos) => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
            () => resolve(null),
            { enableHighAccuracy: true, timeout: 8000, maximumAge: 10000 }
          );
        });
      }

      // --- Overpass helpers ---
      const OP_URL = "https://overpass-api.de/api/interpreter";
      function overpassFetch(query) {
        const url = OP_URL + "?data=" + encodeURIComponent(query);
        return fetch(url).then((r) => r.json());
      }
      function toLatLng(el) {
        if (el.type === "node") return [el.lat, el.lon];
        if (el.center) return [el.center.lat, el.center.lon];
        return null;
      }
      function elemName(tags = {}) { return tags.name || tags.ref || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"; }
      function popupFromTags(tags = {}) {
        const name = elemName(tags);
        const addr = [tags["addr:street"], tags["addr:housenumber"], tags["addr:city"]].filter(Boolean).join(" ");
        const brand = tags.brand ? `<div><strong>–ë—Ä–µ–Ω–¥:</strong> ${tags.brand}</div>` : "";
        const phone = tags.phone ? `<div><strong>–¢–µ–ª.:</strong> ${tags.phone}</div>` : "";
        const website = tags.website ? `<div><a href="${tags.website}" target="_blank" rel="noopener">–°–∞–π—Ç</a></div>` : "";
        const shower = (tags.shower === "yes" || tags["shower:male"] === "yes" || tags["shower:female"] === "yes")
          ? `<div>üöø –î—É—à: –µ—Å—Ç—å</div>` : "";
        const parking = (tags.parking === "yes" || tags.parking === "truck") ? `<div>üÖø –ü–∞—Ä–∫–æ–≤–∫–∞: –µ—Å—Ç—å</div>` : "";
        return `<div style="min-width:200px"><strong>${name}</strong>${addr?`<div>${addr}</div>`:""}${brand}${phone}${website}${shower}${parking}</div>`;
      }
      function radiusMeters() {
        const km = parseFloat(document.getElementById("radiusKm").value) || 50;
        return Math.max(5000, Math.min(300000, km * 1000));
      }

      // --- Overpass query builder ---
      function buildQuery(lat, lon, r) {
        // 1) TIR-–ø–∞—Ä–∫–∏–Ω–≥–∏ (+ —Ä–µ–¥–∫–∏–π amenity=truck_stop)
        const qTruck = `(
          node["amenity"="parking"]["parking"="truck"](around:${r},${lat},${lon});
          way["amenity"="parking"]["parking"="truck"](around:${r},${lat},${lon});
          relation["amenity"="parking"]["parking"="truck"](around:${r},${lat},${lon});
          node["amenity"="truck_stop"](around:${r},${lat},${lon});
          way["amenity"="truck_stop"](around:${r},${lat},${lon});
          relation["amenity"="truck_stop"](around:${r},${lat},${lon});
        );`;

        // 2) –ó–∞–ø—Ä–∞–≤–∫–∏; –¥—É—à/–ø–∞—Ä–∫–æ–≤–∫–∞ ‚Äî —Ç–µ–≥–∏ + –ø–æ–∏—Å–∫ –¥—É—à–µ–≤—ã—Ö —Ä—è–¥–æ–º (amenity=shower)
        const qFuel = `(
          node["amenity"="fuel"](around:${r},${lat},${lon});
          way["amenity"="fuel"](around:${r},${lat},${lon});
          relation["amenity"="fuel"](around:${r},${lat},${lon});
          node["amenity"="shower"](around:${r},${lat},${lon});
          way["amenity"="shower"](around:${r},${lat},${lon});
          relation["amenity"="shower"](around:${r},${lat},${lon});
        );`;

        // 3) –ú–æ—Ç–µ–ª–∏/–æ—Ç–µ–ª–∏
        const qMotel = `(
          node["tourism"~"^(motel|hotel)$"](around:${r},${lat},${lon});
          way["tourism"~"^(motel|hotel)$"](around:${r},${lat},${lon});
          relation["tourism"~"^(motel|hotel)$"](around:${r},${lat},${lon});
        );`;

        // 4) –ü—Ä–æ–º–∑–æ–Ω—ã
        const qIndustrial = `(
          way["landuse"="industrial"](around:${r},${lat},${lon});
          relation["landuse"="industrial"](around:${r},${lat},${lon});
        );`;

        // 5) –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤ (no-go / –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)
        const qNoGo = `(
          way["highway"]["hgv"="no"](around:${r},${lat},${lon});
          way["highway"]["goods"="no"](around:${r},${lat},${lon});
          way["highway"]["motor_vehicle"="no"](around:${r},${lat},${lon});
          way["highway"]["access"="no"](around:${r},${lat},${lon});
          way["highway"]["hgv:conditional"](around:${r},${lat},${lon});
          way["highway"]["motor_vehicle:conditional"](around:${r},${lat},${lon});
          way["highway"]["maxweight"](around:${r},${lat},${lon});
          way["highway"]["maxaxleload"](around:${r},${lat},${lon});
          way["highway"]["maxheight"](around:${r},${lat},${lon});
          way["highway"]["maxwidth"](around:${r},${lat},${lon});
          way["highway"]["maxlength"](around:${r},${lat},${lon});
          relation["type"="restriction"]["restriction"~"hgv|goods"](around:${r},${lat},${lon});
        );`;

        return `
          [out:json][timeout:60];
          (
            ${document.getElementById("cbTruck").checked ? qTruck : ""}
            ${document.getElementById("cbFuel").checked  ? qFuel  : ""}
            ${document.getElementById("cbMotel").checked ? qMotel : ""}
            ${document.getElementById("cbIndustrial").checked ? qIndustrial : ""}
            ${document.getElementById("cbNoGo").checked ? qNoGo : ""}
          );
          out tags center geom;
        `;
      }

      // --- Main loaders ---
      async function loadPOIs(lat, lon) {
        const r = radiusMeters();
        const query = buildQuery(lat, lon, r);
        clusterTruck.clearLayers(); clusterFuel.clearLayers(); clusterMotel.clearLayers(); industrialLayer.clearLayers(); noGoLayer.clearLayers();

        try {
          const data = await overpassFetch(query);
          const elements = data.elements || [];

          // for fuel shower proximity
          const showers = elements.filter(el => (el.tags || {}).amenity === 'shower').map(el => toLatLng(el)).filter(Boolean);
          const truckParksLatLng = [];

          elements.forEach((el) => {
            const p = toLatLng(el); if (!p) return;
            const tags = el.tags || {};

            // 1) Truck parkings
            if ((tags.amenity === "parking" && tags.parking === "truck") || tags.amenity === "truck_stop") {
              const m = L.marker(p, { icon: ICONS.truck }).bindPopup(popupFromTags(tags));
              m.addTo(clusterTruck);
              truckParksLatLng.push({ lat: p[0], lon: p[1] });
              return;
            }

            // 2) Fuel with parking/shower
            if (tags.amenity === "fuel") {
              const hasParkingTag = (tags.parking === "yes" || tags.parking === "truck" || tags["parking:lanes"]);
              const nearTruckParking = truckParksLatLng.some((pk) => distanceMeters(p[0], p[1], pk.lat, pk.lon) < 180);
              const hasShowerTag = (tags.shower === "yes" || tags["shower:male"] === "yes" || tags["shower:female"] === "yes");
              const nearShower = showers.some(s => distanceMeters(p[0], p[1], s[0], s[1]) < 200);

              if (hasParkingTag || nearTruckParking || hasShowerTag || nearShower) {
                const m = L.marker(p, { icon: ICONS.fuel }).bindPopup(popupFromTags(tags));
                m.addTo(clusterFuel);
              }
              return;
            }

            // 3) Motels/Hotels
            if (tags.tourism === "motel" || tags.tourism === "hotel") {
              const m = L.marker(p, { icon: ICONS.motel }).bindPopup(popupFromTags(tags));
              m.addTo(clusterMotel);
              return;
            }

            // 4) Industrial zones
            if (tags.landuse === "industrial") {
              if (el.geometry) {
                const latlngs = el.geometry.map((g) => [g.lat, g.lon]);
                const poly = L.polygon(latlngs, { color: "#666", weight: 1, fillColor: "#999", fillOpacity: 0.15 });
                poly.bindPopup(popupFromTags(tags)); poly.addTo(industrialLayer);
              } else {
                L.circle(p, { radius: 80, color: "#666", weight: 1, fillColor: "#999", fillOpacity: 0.15 }).addTo(industrialLayer);
              }
              return;
            }

            // 5) Truck no-go / restrictions
            const isRestriction =
              tags.hgv === "no" ||
              tags.goods === "no" ||
              tags.motor_vehicle === "no" ||
              tags.access === "no" ||
              tags["hgv:conditional"] ||
              tags["motor_vehicle:conditional"] ||
              tags.maxweight || tags.maxaxleload || tags.maxheight || tags.maxwidth || tags.maxlength ||
              (tags.type === "restriction");

            if (isRestriction) {
              // –ª–∏–Ω–∏–∏/–ø–æ–ª–∏–≥–æ–Ω—ã –¥–ª—è ways/relations
              if (el.geometry && el.geometry.length >= 2) {
                const latlngs = el.geometry.map((g) => [g.lat, g.lon]);
                const pline = (el.type === "way")
                  ? L.polyline(latlngs, { color: "#d70000", weight: 3, opacity: 0.85 })
                  : L.polygon(latlngs, { color: "#d70000", weight: 2, fillColor: "#ff4d4d", fillOpacity: 0.25 });
                pline.bindPopup(`<div style="min-width:220px"><strong>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è –¢–°</strong>
                  ${buildRestrictionSummary(tags)}</div>`);
                pline.addTo(noGoLayer);
              } else if (p) {
                L.circle(p, { radius: 50, color: "#d70000", weight: 2, fillColor: "#ff4d4d", fillOpacity: 0.25 })
                  .bindPopup(`<strong>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è –¢–°</strong>${buildRestrictionSummary(tags)}`).addTo(noGoLayer);
              }
            }
          });
        } catch (err) {
          console.error(err);
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ—á–∫–∏ –∏–∑ Overpass. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–¥–∏—É—Å –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–∑–∂–µ.");
        }
      }

      function buildRestrictionSummary(tags = {}) {
        const items = [];
        const pushIf = (k, label) => { if (tags[k]) items.push(`${label}: <b>${tags[k]}</b>`); };
        if (tags.hgv === "no") items.push("HGV: <b>–∑–∞–ø—Ä–µ—â–µ–Ω–æ</b>");
        if (tags.goods === "no") items.push("Goods: <b>–∑–∞–ø—Ä–µ—â–µ–Ω–æ</b>");
        if (tags.motor_vehicle === "no") items.push("Motor vehicle: <b>–∑–∞–ø—Ä–µ—â–µ–Ω–æ</b>");
        if (tags.access === "no") items.push("Access: <b>–∑–∞–ø—Ä–µ—â–µ–Ω–æ</b>");
        pushIf("hgv:conditional", "HGV (—É—Å–ª–æ–≤–Ω–æ)");
        pushIf("motor_vehicle:conditional", "Motor vehicle (—É—Å–ª–æ–≤–Ω–æ)");
        pushIf("maxweight", "Max weight");
        pushIf("maxaxleload", "Max axle load");
        pushIf("maxheight", "Max height");
        pushIf("maxwidth", "Max width");
        pushIf("maxlength", "Max length");
        return items.length ? `<div style="margin-top:6px">${items.join("<br>")}</div>` : "";
      }

      // --- Utils ---
      function distanceMeters(lat1, lon1, lat2, lon2) {
        const R = 6371000, dLat=((lat2-lat1)*Math.PI)/180, dLon=((lon2-lon1)*Math.PI)/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      }

      // --- UI events ---
      document.getElementById("btnLocate").addEventListener("click", async () => {
        const loc = await locateUser();
        if (loc) { setUserLocation(loc.lat, loc.lon); map.setView([loc.lat, loc.lon], 11); }
        else { alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ."); }
      });
      document.getElementById("btnReload").addEventListener("click", async () => {
        const center = userMarker ? userMarker.getLatLng() : map.getCenter();
        await loadPOIs(center.lat, center.lng);
      });
      document.getElementById("cbTruck").addEventListener("change", () => {
        if (document.getElementById("cbTruck").checked) map.addLayer(clusterTruck); else map.removeLayer(clusterTruck);
      });
      document.getElementById("cbFuel").addEventListener("change", () => {
        if (document.getElementById("cbFuel").checked) map.addLayer(clusterFuel); else map.removeLayer(clusterFuel);
      });
      document.getElementById("cbMotel").addEventListener("change", () => {
        if (document.getElementById("cbMotel").checked) map.addLayer(clusterMotel); else map.removeLayer(clusterMotel);
      });
      document.getElementById("cbIndustrial").addEventListener("change", () => {
        if (document.getElementById("cbIndustrial").checked) map.addLayer(industrialLayer); else map.removeLayer(industrialLayer);
      });
      document.getElementById("cbNoGo").addEventListener("change", () => {
        if (document.getElementById("cbNoGo").checked) map.addLayer(noGoLayer); else map.removeLayer(noGoLayer);
        const c = userMarker ? userMarker.getLatLng() : map.getCenter();
        loadPOIs(c.lat, c.lng); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º, —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
      });

      // --- Init ---
      (async function init() {
        const loc = await locateUser();
        if (loc) { setUserLocation(loc.lat, loc.lon); map.setView([loc.lat, loc.lon], 11); }
        const center = loc ? [loc.lat, loc.lon] : [52.2297, 21.0122];
        await loadPOIs(center[0], center[1]);
      })();

      // --- Legend toggle (smooth) ---
      const legend = document.getElementById("legend");
      const legendHeader = document.getElementById("legendHeader");
      const legendContent = document.getElementById("legendContent");
      function collapseLegend() {
        legendContent.style.height = legendContent.scrollHeight + "px";
        requestAnimationFrame(() => { legend.classList.add("collapsed"); legendContent.style.height = "0px"; });
      }
      function expandLegend() {
        legendContent.style.height = "0px"; legend.classList.remove("collapsed");
        requestAnimationFrame(() => { legendContent.style.height = legendContent.scrollHeight + "px"; });
        const onEnd = (e) => { if (e.propertyName === "height") { legendContent.style.height = "auto"; legendContent.removeEventListener("transitionend", onEnd); } };
        legendContent.addEventListener("transitionend", onEnd);
      }
      legendHeader.addEventListener("click", () => {
        const isCollapsed = legend.classList.contains("collapsed");
        if (isCollapsed) expandLegend(); else collapseLegend();
      });
      window.addEventListener("load", () => {
        if (legend.classList.contains("collapsed")) legendContent.style.height = "0px";
        else legendContent.style.height = "auto";
      });

      /*
       * ===== –ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å HERE/PTV –¥–ª—è ¬´–∫—Ä–∞—Å–Ω—ã—Ö –∑–æ–Ω¬ª –≤–º–µ—Å—Ç–æ Overpass =====
       * 1) –ü–æ–ª—É—á–∏—Ç–µ –∫–ª—é—á (HERE Fleet/Truck Restrictions –∏–ª–∏ PTV Truck Restrictions).
       * 2) –í—ã–Ω–µ—Å–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é fetchTruckRestrictions(lat, lon, radius).
       * 3) –ü–æ—Å—Ç—Ä–æ–π—Ç–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞ GeoJSON/–ª–∏–Ω–∏–∏ –∏ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –≤ noGoLayer (–∫–∞–∫ –≤—ã—à–µ).
       * –≠—Ç–æ –¥–∞—Å—Ç –±–æ–ª—å—à–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ –∏ —É—á—Ç—ë—Ç —Å–≤–µ–∂–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ/—É—Å–ª–æ–≤–Ω—ã–µ –∑–∞–ø—Ä–µ—Ç—ã.
       */
    </script>
  </body>
</html>
