<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Truck Drivers Map ‚Äî TruckWork</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster (optional but handy for density) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }

    /* Top controls */
    .topbar {
      position: absolute; z-index: 1000; top: 10px; left: 50%; transform: translateX(-50%);
      width: calc(100% - 20px); max-width: 1100px;
      background: rgba(255,255,255,.96); padding: 10px 12px; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.12);
      display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center;
      font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .topbar .group { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .topbar .chip {
      border:1px solid #ddd; padding:6px 10px; border-radius: 999px; background:#fff; cursor:pointer; user-select:none;
    }
    .topbar .chip input { margin-right:6px; }
    .topbar button { border:1px solid #ddd; padding:6px 10px; border-radius:8px; background:#fff; cursor:pointer; }
    .topbar input[type="number"] { width: 84px; padding: 4px 6px; }

    /* Bottom-left: sliding marker list */
    .poi-panel {
      position: absolute; left: 10px; bottom: 10px; z-index: 1000; width: 300px;
      max-height: 40%; display: flex; flex-direction: column;
      background: rgba(255,255,255,.96); border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.12);
      overflow: hidden;
      font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .poi-panel header {
      display:flex; align-items:center; justify-content:space-between; padding: 8px 10px; border-bottom:1px solid #eee;
      cursor: pointer; background:#fff;
    }
    .poi-panel .body {
      transition: max-height .25s ease; overflow:auto; max-height: 220px;
    }
    .poi-item { padding:8px 10px; border-bottom:1px solid #f2f2f2; cursor:pointer; }
    .poi-item:hover { background:#f8f8f8; }
    .tag { display:inline-block; padding:2px 6px; border-radius:999px; font-size:12px; border:1px solid #ddd; margin-left:6px; }

    /* Bottom-right: restrictions list */
    .restrictions {
      position: absolute; right: 10px; bottom: 10px; z-index: 1000; width: 340px;
      max-height: 40%; background: rgba(255,255,255,.96); border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.12);
      overflow: hidden; display:flex; flex-direction: column;
      font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .restrictions header {
      padding: 8px 10px; border-bottom: 1px solid #eee; background:#fff; display:flex; align-items:center; gap:8px;
    }
    .restrictions .body { overflow:auto; padding: 8px 10px; }
    .restrictions .rule { padding:8px 8px; border-left:3px solid #dc3250; background:#fff; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,.06); margin-bottom:8px; }
    .muted { opacity:.7; }

    /* Simple colored markers */
    .dot { width: 14px; height: 14px; border-radius: 50%; display:inline-block; border: 2px solid #333; margin-right: 6px; }
    .dot.service{background:#89b5ff;border-color:#2b6cff;}
    .dot.repair{background:#ffd3a1;border-color:#c76a00;}
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Top filters -->
  <div class="topbar">
    <div class="group">
      <strong>–†–∞–¥–∏—É—Å (–∫–º)</strong>
      <input id="radiusKm" type="number" value="50" min="5" max="300" step="5" />
    </div>

    <div class="group">
      <label class="chip"><input type="checkbox" id="cbService" checked /> –°–µ—Ä–≤–∏—Å –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤</label>
      <label class="chip"><input type="checkbox" id="cbRepair" checked /> –†–µ–º–æ–Ω—Ç/–º–∞—Å—Ç–µ—Ä—Å–∫–∏–µ</label>
    </div>

    <div class="group">
      <button id="btnLocate">–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
      <button id="btnReload">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
  </div>

  <!-- Bottom-left: sliding list of current POIs -->
  <div class="poi-panel" id="poiPanel">
    <header id="poiToggle">
      <div><strong>–û–±—ä–µ–∫—Ç—ã —Ä—è–¥–æ–º</strong> <span class="tag" id="poiCount">0</span></div>
      <div id="poiArrow">‚ñ≤</div>
    </header>
    <div class="body" id="poiBody"></div>
  </div>

  <!-- Bottom-right: traffic ban / restrictions list -->
  <div class="restrictions" id="restrictionsPanel">
    <header>
      <strong>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è (–ø—Ä–∞–≤–∏–ª–∞)</strong>
      <span class="muted" id="countryInfo"></span>
    </header>
    <div class="body" id="restrictionsBody">
      <div class="muted">–ó–¥–µ—Å—å –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤ (–≤—ã—Ö–æ–¥–Ω—ã–µ, –ø—Ä–∞–∑–¥–Ω–∏–∫–∏, –Ω–æ—á–Ω—ã–µ –∑–∞–ø—Ä–µ—Ç—ã –∏ —Ç.–ø.). –ü–æ–¥–∫–ª—é—á–∏—Ç–µ Trafficban API.</div>
    </div>
  </div>

  <script>
    // ====== BASE MAP ======
    const map = L.map("map", { zoomSnap: 0.5 }).setView([52.23, 21.01], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // ====== ICONS ======
    const iconDot = (cls) => L.divIcon({
      className: "marker",
      html:`<span class="dot ${cls}"></span>`,
      iconSize:[16,16], iconAnchor:[8,8]
    });

    // ====== LAYERS ======
    const clusterService = L.markerClusterGroup({ disableClusteringAtZoom: 13 });
    const clusterRepair  = L.markerClusterGroup({ disableClusteringAtZoom: 13 });
    map.addLayer(clusterService);
    map.addLayer(clusterRepair);

    // ====== UI ELEMENTS ======
    const elRadius = document.getElementById("radiusKm");
    const elCbService = document.getElementById("cbService");
    const elCbRepair  = document.getElementById("cbRepair");
    const elPoiCount  = document.getElementById("poiCount");
    const elPoiBody   = document.getElementById("poiBody");
    const elPoiToggle = document.getElementById("poiToggle");
    const elPoiArrow  = document.getElementById("poiArrow");
    const elCountryInfo = document.getElementById("countryInfo");
    const elRestrictionsBody = document.getElementById("restrictionsBody");

    let poiCollapsed = false;
    elPoiToggle.addEventListener("click", () => {
      poiCollapsed = !poiCollapsed;
      const body = document.getElementById("poiBody");
      body.style.maxHeight = poiCollapsed ? "0px" : "220px";
      elPoiArrow.textContent = poiCollapsed ? "‚ñº" : "‚ñ≤";
    });

    // ====== HELPERS ======
    const overpass = q => fetch("https://overpass-api.de/api/interpreter?data="+encodeURIComponent(q)).then(r=>r.json());
    const radiusM = () => Math.min(300000, Math.max(5000, +elRadius.value*1000));

    function toLatLng(el) {
      if (el.type === "node") return [el.lat, el.lon];
      if (el.center) return [el.center.lat, el.center.lon];
      return null;
    }
    function popupFromTags(t, category) {
      const name = t.name || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
      let s = `<b>${name}</b><br>`;
      if (t.operator) s += `${t.operator}<br>`;
      if (t.brand) s += `–ë—Ä–µ–Ω–¥: ${t.brand}<br>`;
      const phone = t.phone || t.contact:phone || t["contact:phone"];
      if (phone) s += `üìû ${phone}<br>`;
      if (t.opening_hours) s += `‚è∞ ${t.opening_hours}<br>`;
      if (t.website) s += `<a href="${t.website}" target="_blank">–°–∞–π—Ç</a>`;
      return s;
    }

    // List builder (bottom-left)
    function rebuildPoiList() {
      elPoiBody.innerHTML = "";
      const items = [];

      if (elCbService.checked) {
        clusterService.getLayers().forEach(m => {
          items.push({ layer: m, cat: "service", title: m.options._title || "–°–µ—Ä–≤–∏—Å –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤" });
        });
      }
      if (elCbRepair.checked) {
        clusterRepair.getLayers().forEach(m => {
          items.push({ layer: m, cat: "repair", title: m.options._title || "–†–µ–º–æ–Ω—Ç/–º–∞—Å—Ç–µ—Ä—Å–∫–∞—è" });
        });
      }
      elPoiCount.textContent = items.length;

      items.forEach(({layer, cat, title}) => {
        const div = document.createElement("div");
        div.className = "poi-item";
        div.innerHTML = `<span class="dot ${cat}"></span>${title}`;
        div.onclick = () => {
          const ll = layer.getLatLng();
          map.setView(ll, Math.max(map.getZoom(), 14));
          layer.openPopup();
        };
        elPoiBody.appendChild(div);
      });
    }

    // ====== OSM LOADERS (Service & Repair) ======
    async function loadTruckServices(lat, lon) {
      clusterService.clearLayers();
      if (!elCbService.checked) return;

      // Service places for trucks: service:vehicle:truck=yes (common on fuel/service sites)
      const q = `[out:json][timeout:40];
      (
        node["service:vehicle:truck"="yes"](around:${radiusM()},${lat},${lon});
        way["service:vehicle:truck"="yes"](around:${radiusM()},${lat},${lon});
        node["amenity"="truck_service"](around:${radiusM()},${lat},${lon});
        way["amenity"="truck_service"](around:${radiusM()},${lat},${lon});
      );
      out center tags;`;
      const data = await overpass(q);
      (data.elements || []).forEach(el => {
        const p = toLatLng(el); if (!p) return;
        const t = el.tags || {};
        const m = L.marker(p, { icon: iconDot("service"), _title: t.name || "–°–µ—Ä–≤–∏—Å –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤" })
          .bindPopup(popupFromTags(t, "service"));
        clusterService.addLayer(m);
      });
    }

    async function loadRepair(lat, lon) {
      clusterRepair.clearLayers();
      if (!elCbRepair.checked) return;

      // Truck-friendly repair: car_repair with hgv=yes|designated, truck repair hints, tyres for HGV
      const q = `[out:json][timeout:40];
      (
        node["shop"="car_repair"]["hgv"~"^(yes|designated)$"](around:${radiusM()},${lat},${lon});
        way["shop"="car_repair"]["hgv"~"^(yes|designated)$"](around:${radiusM()},${lat},${lon});

        node["shop"="tyres"]["hgv"~"^(yes|designated)$"](around:${radiusM()},${lat},${lon});
        way["shop"="tyres"]["hgv"~"^(yes|designated)$"](around:${radiusM()},${lat},${lon});

        node["truck:repair"="yes"](around:${radiusM()},${lat},${lon});
        way["truck:repair"="yes"](around:${radiusM()},${lat},${lon});
      );
      out center tags;`;
      const data = await overpass(q);
      (data.elements || []).forEach(el => {
        const p = toLatLng(el); if (!p) return;
        const t = el.tags || {};
        const m = L.marker(p, { icon: iconDot("repair"), _title: t.name || "–†–µ–º–æ–Ω—Ç/–º–∞—Å—Ç–µ—Ä—Å–∫–∞—è" })
          .bindPopup(popupFromTags(t, "repair"));
        clusterRepair.addLayer(m);
      });
    }

    // ====== Restrictions (Trafficban) ======
    // Minimal integration scaffold: set your API key & endpoint according to their docs.
    const TRAFFICBAN_API_KEY = ""; // <- put your key here
    async function getCountryByLatLon(lat, lon) {
      try {
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
        const j = await r.json();
        const country = j?.address?.country || "";
        const cc = j?.address?.country_code ? j.address.country_code.toUpperCase() : "";
        return { country, cc };
      } catch {
        return { country: "", cc: "" };
      }
    }

    async function loadTrafficBans(lat, lon) {
      elRestrictionsBody.innerHTML = `<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π‚Ä¶</div>`;
      const { country, cc } = await getCountryByLatLon(lat, lon);
      elCountryInfo.textContent = country ? `‚Äî ${country}` : "";

      // If no API key, show hint and exit gracefully
      if (!TRAFFICBAN_API_KEY) {
        elRestrictionsBody.innerHTML = `
          <div class="muted">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ Trafficban API (–≤—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é <code>TRAFFICBAN_API_KEY</code>).
          –ë—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –¥–≤–∏–∂–µ–Ω–∏—è –¥–ª—è —Å—Ç—Ä–∞–Ω—ã –ø–æ —Ü–µ–Ω—Ç—Ä—É –∫–∞—Ä—Ç—ã.</div>`;
        return;
      }

      try {
        // TODO: adapt to Trafficban‚Äôs actual endpoint & parameters per their docs.
        // Example shape (pseudo):
        // const url = `https://trafficban.com/api/v1/restrictions?country=${cc}&date=${new Date().toISOString().slice(0,10)}`;
        // const res = await fetch(url, { headers: { Authorization: `Bearer ${TRAFFICBAN_API_KEY}` } });

        // Placeholder demo until endpoint is set:
        const demo = {
          rules: [
            { title: "–í–æ—Å–∫—Ä–µ—Å–Ω—ã–π –∑–∞–ø—Ä–µ—Ç", text: "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 00:00‚Äì22:00 –¥–ª—è –¢–° >7.5 —Ç, –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Å–∫–æ—Ä–æ–ø–æ—Ä—Ç—è—â–∏—Ö—Å—è.", ref: "¬ß123 Abs. 4" },
            { title: "–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –¥–Ω–∏", text: "1 –∏ 11 –Ω–æ—è–±—Ä—è ‚Äî –ø–æ–ª–Ω—ã–π –∑–∞–ø—Ä–µ—Ç –¥–ª—è –¢–° >12 —Ç (—Å–º. –ø–µ—Ä–µ—á–µ–Ω—å –∏—Å–∫–ª—é—á–µ–Ω–∏–π).", ref: "Festtage Liste" }
          ]
        };

        elRestrictionsBody.innerHTML = demo.rules.map(r => `
          <div class="rule">
            <b>${r.title}</b><br>${r.text}
            ${r.ref ? `<div class="muted" style="margin-top:4px">–ò—Å—Ç–æ—á–Ω–∏–∫: ${r.ref}</div>` : ""}
          </div>
        `).join("");

      } catch (e) {
        elRestrictionsBody.innerHTML = `<div class="muted">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div>`;
      }
    }

    // ====== LOAD ALL ======
    async function loadAll(lat, lon) {
      await loadTruckServices(lat, lon);
      await loadRepair(lat, lon);
      rebuildPoiList();
      await loadTrafficBans(lat, lon);
    }

    // ====== GEOLOCATION / UI ======
    async function locateUser() {
      if (!navigator.geolocation) return null;
      return new Promise(res => {
        navigator.geolocation.getCurrentPosition(
          pos => res({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
          () => res(null),
          { enableHighAccuracy: true, timeout: 8000 }
        );
      });
    }

    document.getElementById("btnLocate").onclick = async () => {
      const loc = await locateUser();
      if (loc) { map.setView([loc.lat, loc.lon], 11); await loadAll(loc.lat, loc.lon); }
      else alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é");
    };
    document.getElementById("btnReload").onclick = async () => {
      const c = map.getCenter(); await loadAll(c.lat, c.lng);
    };

    // Filter toggles -> reload visible layers only
    [elCbService, elCbRepair].forEach(cb => {
      cb.addEventListener("change", async () => {
        const c = map.getCenter();
        if (cb === elCbService) clusterService.clearLayers();
        if (cb === elCbRepair)  clusterRepair.clearLayers();
        await loadAll(c.lat, c.lng);
      });
    });

    // Radius change -> reload
    elRadius.addEventListener("change", async () => {
      const c = map.getCenter(); await loadAll(c.lat, c.lng);
    });

    // When map stops moving a bit, refresh traffic bans for current country (not spamming)
    let tbTimer = null;
    map.on("moveend", () => {
      if (tbTimer) clearTimeout(tbTimer);
      tbTimer = setTimeout(async () => {
        const c = map.getCenter();
        await loadTrafficBans(c.lat, c.lng);
      }, 600);
    });

    // ====== INIT ======
    (async () => {
      const c = map.getCenter();
      await loadAll(c.lat, c.lng);
    })();
  </script>
</body>
</html>
