<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Truck Drivers Map — TruckWork</title>

  <!-- Leaflet + MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html, body { height:100%; margin:0; }
    #map { position:fixed; inset:0; }

    /* ---------- UI ---------- */
    .panel {
      position:absolute; z-index:1000; background:rgba(255,255,255,.96);
      border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.12);
      font:14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      overflow:hidden;
    }
    .panel header {
      display:flex; align-items:center; gap:8px; padding:8px 10px; background:#fff; border-bottom:1px solid #eee;
    }
    .panel .body { padding:10px; }
    .caret { cursor:pointer; margin-left:auto; border:1px solid #ddd; border-radius:8px; padding:4px 8px; background:#fff; }
    .collapsed .body { display:none; }
    .collapsed header { border-bottom:none; }

    .topbar { top:10px; left:50%; transform:translateX(-50%); width:calc(100% - 20px); max-width:1180px; }
    .topbar .body { display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center; }
    .group { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .chip { border:1px solid #ddd; padding:6px 10px; border-radius:999px; background:#fff; user-select:none; }
    .chip input { margin-right:6px; }
    .topbar select, .topbar input[type="number"] { border:1px solid #ddd; border-radius:8px; padding:6px 10px; background:#fff; }

    .legend { left:10px; bottom:10px; min-width:280px; }
    .legend .row { display:flex; align-items:center; gap:8px; margin:6px 0; }
    .legend .hint { margin-top:6px; opacity:.7; font-size:12px; }

    .restrictions { right:10px; bottom:10px; width:340px; max-height:40%; }
    .restrictions .rule { padding:8px; border-left:3px solid #dc3250; background:#fff; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,.06); margin-bottom:8px; }
    .muted { opacity:.7; }

    /* ---------- markers ---------- */
    .dot { width:14px; height:14px; border-radius:50%; display:inline-block; border:2px solid #333; }
    .dot.service{background:#89b5ff;border-color:#2b6cff;}
    .dot.repair{background:#ffd3a1;border-color:#c76a00;}
    .dot.parking{background:#b8f7b1;border-color:#2a7a2a;}
    .dot.fuel{background:#cde1ff;border-color:#3468ff;}
    .dot.roadpt{background:#ffd1d1;border-color:#d22;}

    .pill { display:inline-block; padding:2px 6px; border-radius:999px; font-size:11px; border:1px solid #ccc; background:#fff; }
    .pill.ok{border-color:#2a7a2a;color:#2a7a2a;}
    .pill.warn{border-color:#c76a00;color:#c76a00;}
    .pill.full{border-color:#d22;color:#d22;}

    .toast {
      position:absolute; left:50%; top:78px; transform:translateX(-50%);
      z-index:1200; background:rgba(255,255,255,.96); border:1px solid #eee; border-radius:10px;
      padding:8px 10px; box-shadow:0 2px 10px rgba(0,0,0,.08); font:13px system-ui;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- TOPBAR -->
  <div class="panel topbar" id="panelTop">
    <header><strong>Фильтры и радиус</strong><button class="caret" id="toggleTop">▲</button></header>
    <div class="body">
      <div class="group">
        <strong>Радиус (км)</strong>
        <input id="radiusKm" type="number" value="50" min="5" max="500" step="5" />
      </div>
      <div class="group">
        <label class="chip"><input type="checkbox" id="cbService" checked> Сервис грузовиков</label>
        <label class="chip"><input type="checkbox" id="cbRepair" checked> Ремонт/мастерские</label>
        <label class="chip"><input type="checkbox" id="cbMTparking" checked> Паркинги TIR</label>
        <label class="chip"><input type="checkbox" id="cbMTfuel" checked> Заправки</label>
        <select id="fuelType">
          <option value="Diesel" selected>Diesel</option>
          <option value="SuperE5">Super E5</option>
          <option value="SuperE10">Super E10</option>
          <option value="SuperPlus">SuperPlus</option>
          <option value="Autogas">Autogas</option>
        </select>
        <label class="chip"><input type="checkbox" id="cbMTroadPt" checked> Работы — точки</label>
        <label class="chip"><input type="checkbox" id="cbMTroadLn" checked> линии</label>
      </div>
      <div class="group" style="justify-self:end; opacity:.6">Карта: Carto Light</div>
    </div>
  </div>

  <!-- LEGEND -->
  <div class="panel legend" id="panelLegend">
    <header><strong>Легенда</strong><button class="caret" id="toggleLegend">▲</button></header>
    <div class="body">
      <div class="row"><span class="dot service"></span>Сервис для грузовиков</div>
      <div class="row"><span class="dot repair"></span>Ремонт / шины</div>
      <div class="row"><span class="dot parking"></span>Паркинг TIR</div>
      <div class="row"><span class="dot fuel"></span>Заправка</div>
      <div class="row"><span class="dot roadpt"></span>Дорожные работы</div>
      <div class="hint">Нажмите на маркер — подробности, контакты, цены.</div>
    </div>
  </div>

  <!-- RESTRICTIONS -->
  <div class="panel restrictions collapsed" id="panelRestr">
    <header><strong>Ограничения движения</strong><span class="muted" id="countryInfo"></span><button class="caret" id="toggleRestr">▼</button></header>
    <div class="body" id="restrictionsBody"><div class="muted">Вставьте ключ Trafficban API, чтобы отображать реальные правила по стране.</div></div>
  </div>

  <script>
  /* ========== CONFIG ========== */
  const MAPTRIP_TOKEN = "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJzMjQ2NzZAcGp3c3RrLmVkdS5wbCIsImF1dGgiOiJST0xFX1VTRVIiLCJpZCI6MjM0MDAzOCwiY29tcGFueUlkIjoyMzQwMTg2LCJleHAiOjE3NjQyMzE2NDZ9.TseoqPIXt3oTM1DBAR80EuueQA53zjXjCDnsoVCfzqf0syAyquSqIwshzBYLyksEQLTIATHqA0SyGAey0dCtxw";
  const MAPTRIP_BASE  = "https://api.maptrip.de/v1";
  const MT_HEADERS = () => ({
    "accept": "application/json",
    "Authorization": "Bearer " + MAPTRIP_TOKEN
  });

  /* ========== MAP INIT ========== */
  const map = L.map("map", {
    zoomSnap: .5,
    layers: [L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {maxZoom:20})]
  });
  const stateKey = "truckwork.map.state.v3";

  const loadState = () => JSON.parse(localStorage.getItem(stateKey) || "{}");
  const saveState = s => localStorage.setItem(stateKey, JSON.stringify(Object.assign(loadState(), s)));

  const s = loadState();
  if (s.center && s.zoom) map.setView(s.center, s.zoom);
  else map.setView([52.23,21.01],11);

  /* ========== LAYERS ========== */
  const MC_OPTS = { disableClusteringAtZoom:13, chunkedLoading:true, removeOutsideVisibleBounds:false };
  const iconDot = c => L.divIcon({ className:"marker", html:`<span class="dot ${c}"></span>`, iconSize:[16,16], iconAnchor:[8,8] });
  const clusterService=L.markerClusterGroup(MC_OPTS), clusterRepair=L.markerClusterGroup(MC_OPTS);
  const clusterMTparking=L.markerClusterGroup(MC_OPTS), clusterMTfuel=L.markerClusterGroup(MC_OPTS);
  const mtRoadPt=L.markerClusterGroup(MC_OPTS), mtRoadLn=L.geoJSON(null,{style:()=>({color:"#d22",weight:3,opacity:.9,dashArray:"6,6"})});
  [clusterService,clusterRepair,clusterMTparking,clusterMTfuel,mtRoadPt,mtRoadLn].forEach(l=>map.addLayer(l));

  /* ========== HELPERS ========== */
  let inflight=[];
  function withAbort(init={}){const ac=new AbortController();inflight.push(ac);return {...init,signal:ac.signal};}
  function cleanupInflight(){inflight=inflight.filter(c=>!c.signal.aborted);}
  function bboxParamsFromMap(pad=.35){const b=map.getBounds().pad(pad);const sw=b.getSouthWest(),ne=b.getNorthEast();return{from:`${sw.lat},${sw.lng}`,to:`${ne.lat},${ne.lng}`};}

  function reconcileMarkers(cluster,dict,items,getId,toLatLng,toIcon,toPopup){
    const nextIds=new Set();
    for(const it of items){
      const id=getId(it); if(!id)continue;
      nextIds.add(id);
      const ll=toLatLng(it); if(!ll)continue;
      if(dict[id]){
        const m=dict[id]; const old=m.getLatLng();
        if(old.lat!==ll[0]||old.lng!==ll[1])m.setLatLng(ll);
        m.setIcon(toIcon(it)); m.bindPopup(toPopup(it));
      }else{
        const m=L.marker(ll,{icon:toIcon(it)}).bindPopup(toPopup(it));
        dict[id]=m; cluster.addLayer(m);
      }
    }
    for(const id of Object.keys(dict))if(!nextIds.has(id)){cluster.removeLayer(dict[id]);delete dict[id];}
  }

  /* ========== LOADERS ========== */
  async function overpassPOST(q){
    const eps=[
      "https://overpass-api.de/api/interpreter",
      "https://overpass.kumi.systems/api/interpreter",
      "https://overpass.nchc.org.tw/api/interpreter"
    ];
    for(const ep of eps){
      try{
        const r=await fetch(ep,withAbort({
          method:"POST",
          headers:{"Content-Type":"application/x-www-form-urlencoded"},
          body:"data="+encodeURIComponent(q)
        }));
        if(r.ok){cleanupInflight();return await r.json();}
      }catch{}
    }
    return{elements:[]};
  }

  const seenKeys=new Set();
  function seen(lat,lon){const k=`${Math.round(lat*10000)}:${Math.round(lon*10000)}`;if(seenKeys.has(k))return true;seenKeys.add(k);return false;}

  async function fetchOSMServicesAndRepair(lat,lon,rad){
    seenKeys.clear();
    const q=`[out:json][timeout:50];(node["truck:service"="yes"](around:${rad},${lat},${lon});node["truck:repair"="yes"](around:${rad},${lat},${lon});node["amenity"="car_repair"](around:${rad},${lat},${lon});node["shop"="tyres"](around:${rad},${lat},${lon}););out center tags;`;
    const d=await overpassPOST(q); const list=[];
    for(const el of d.elements||[]){
      const p=el.lat?[el.lat,el.lon]:el.center?[el.center.lat,el.center.lon]:null; if(!p)continue;
      const [la,lo]=p;if(seen(la,lo))continue;
      const t=el.tags||{}, g=/repair|tyre|tire|opon/i.test(t.shop||t.amenity||"")?"repair":"service";
      list.push({id:`osm-${el.id}`,name:t.name,lat:la,lon:lo,addr:[t["addr:street"],t["addr:city"]].filter(Boolean).join(", "),guess:g});
    }
    return list;
  }

  async function fetchOSMRoadworks(){
    const c=map.getCenter(),rad=50000;
    const q=`[out:json][timeout:40];(way["highway"="construction"](around:${rad},${c.lat},${c.lng});node["highway"="construction"](around:${rad},${c.lat},${c.lng}););out geom tags;`;
    const d=await overpassPOST(q);const lines=[],points=[];
    for(const el of d.elements||[]){
      if(el.type==="way"){const g=el.geometry;if(g&&g.length>1)lines.push({id:`rw-${el.id}`,line:g.map(v=>[v.lat,v.lon]),props:{road:el.tags?.ref||""}});}
      else if(el.type==="node")points.push({id:`rwp-${el.id}`,lat:el.lat,lon:el.lon,pr:{road:el.tags?.ref||""}});
    }
    return{lines,points};
  }

  /* ========== MASTER LOAD ========== */
  const dictServ={},dictRep={},dictPark={},dictFuel={},dictRW={};
  async function loadAll(){
    const c=map.getCenter(),rad=50000;
    const osm=await fetchOSMServicesAndRepair(c.lat,c.lng,rad);
    reconcileMarkers(clusterService,dictServ,osm.filter(x=>x.guess!=="repair"),i=>i.id,i=>[i.lat,i.lon],()=>iconDot("service"),i=>i.name||"Сервис");
    reconcileMarkers(clusterRepair,dictRep,osm.filter(x=>x.guess==="repair"),i=>i.id,i=>[i.lat,i.lon],()=>iconDot("repair"),i=>i.name||"Ремонт");

    const rw=await fetchOSMRoadworks();
    reconcileMarkers(mtRoadPt,dictRW,rw.points,i=>i.id,i=>[i.lat,i.lon],()=>iconDot("roadpt"),i=>i.pr.road||"Road works");
    mtRoadLn.clearLayers();
    rw.lines.forEach(l=>mtRoadLn.addData({type:"Feature",geometry:{type:"LineString",coordinates:l.line.map(v=>[v.lon,v.lat])},properties:l.props}));
  }

  /* ========== EVENTS ========== */
  let moveTimer=null;
  map.on("moveend zoomend",()=>{if(moveTimer)clearTimeout(moveTimer);moveTimer=setTimeout(loadAll,400);});
  loadAll();

  // small CRS offset fix
  const orig=map.options.crs.project;
  map.options.crs.project=function(latlng){const p=orig.call(this,latlng);p.x+=1e-7;p.y+=1e-7;return p;};
  </script>
</body>
</html>
