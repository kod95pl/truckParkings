<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Truck Drivers Map ‚Äî TruckWork</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { position: fixed; inset: 0; }

    .topbar {
      position: absolute; z-index: 1000; top: 10px; left: 50%; transform: translateX(-50%);
      width: calc(100% - 20px); max-width: 1100px;
      background: rgba(255,255,255,.96); padding: 10px 12px; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.12);
      display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center;
      font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .topbar .group { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .topbar .chip { border:1px solid #ddd; padding:6px 10px; border-radius:999px; background:#fff; cursor:pointer; user-select:none; }
    .topbar .chip input { margin-right:6px; }
    .topbar button { border:1px solid #ddd; padding:6px 10px; border-radius:8px; background:#fff; cursor:pointer; }
    .topbar input[type="number"] { width: 84px; padding: 4px 6px; }

    /* –õ–µ–≥–µ–Ω–¥–∞ (–Ω–∏–∂–Ω–∏–π –ª–µ–≤—ã–π) */
    .legend {
      position: absolute; left: 10px; bottom: 10px; z-index: 1000;
      background: rgba(255,255,255,.96); border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.12);
      padding: 10px 12px; font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      min-width: 260px;
    }
    .legend .row { display:flex; align-items:center; gap:8px; margin:6px 0; }
    .legend .hint { margin-top:6px; opacity:.7; font-size:12px; }

    /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–Ω–∏–∂–Ω–∏–π –ø—Ä–∞–≤—ã–π) */
    .restrictions {
      position: absolute; right: 10px; bottom: 10px; z-index: 1000; width: 340px;
      max-height: 40%; background: rgba(255,255,255,.96); border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.12);
      overflow: hidden; display:flex; flex-direction: column; font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .restrictions header { padding: 8px 10px; border-bottom: 1px solid #eee; background:#fff; display:flex; align-items:center; gap:8px; }
    .restrictions .body { overflow:auto; padding: 8px 10px; }
    .restrictions .rule { padding:8px 8px; border-left:3px solid #dc3250; background:#fff; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,.06); margin-bottom:8px; }
    .muted { opacity:.7; }

    /* –¢–æ—á–∫–∏ */
    .dot { width:14px; height:14px; border-radius:50%; display:inline-block; border:2px solid #333; }
    .dot.service{background:#89b5ff;border-color:#2b6cff;}
    .dot.repair{background:#ffd3a1;border-color:#c76a00;}
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
  <div class="topbar">
    <div class="group">
      <strong>–†–∞–¥–∏—É—Å (–∫–º)</strong>
      <input id="radiusKm" type="number" value="50" min="5" max="300" step="5" />
    </div>
    <div class="group">
      <label class="chip"><input type="checkbox" id="cbService" checked /> –°–µ—Ä–≤–∏—Å –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤</label>
      <label class="chip"><input type="checkbox" id="cbRepair" checked /> –†–µ–º–æ–Ω—Ç/–º–∞—Å—Ç–µ—Ä—Å–∫–∏–µ</label>
    </div>
    <div class="group">
      <button id="btnLocate">–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
      <button id="btnReload">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
  </div>

  <!-- –õ–µ–≥–µ–Ω–¥–∞ -->
  <div class="legend">
    <div class="row"><span class="dot service"></span>–°–µ—Ä–≤–∏—Å –¥–ª—è –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤</div>
    <div class="row"><span class="dot repair"></span>–†–µ–º–æ–Ω—Ç / –º–∞—Å—Ç–µ—Ä—Å–∫–∏–µ / —à–∏–Ω—ã (HGV)</div>
    <div class="hint">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –º–∞—Ä–∫–µ—Ä ‚Äî –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏, —Ç–µ–ª–µ—Ñ–æ–Ω, —Å–∞–π—Ç.</div>
  </div>

  <!-- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è -->
  <div class="restrictions" id="restrictionsPanel">
    <header>
      <strong>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è (–ø—Ä–∞–≤–∏–ª–∞)</strong>
      <span class="muted" id="countryInfo"></span>
    </header>
    <div class="body" id="restrictionsBody">
      <div class="muted">–í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á Trafficban API, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ —Å—Ç—Ä–∞–Ω–µ.</div>
    </div>
  </div>

  <script>
    // ===== CONFIG: –≤—Å—Ç–∞–≤—å —Å–≤–æ–∏ –∫–ª—é—á–∏ =====
    const FOURSQUARE_API_KEY = "G4IOHLEFEJVKP15H3FPBPGNFYBSDMBLLKN4XFSU24TSH3FH0";   // https://docs.foursquare.com/developer/reference/places-api-overview
    const GEOAPIFY_API_KEY   = "4ec7d28510a8484d8726a1b462c5f34b";   // https://apidocs.geoapify.com/docs/places/
    const PROVIDERS = { foursquare: true, geoapify: true }; // –≤–∫–ª—é—á–∞–π/–≤—ã–∫–ª—é—á–∞–π

    // ===== –ö–∞—Ä—Ç–∞ (—Ç–æ–ª—å–∫–æ Carto Light) =====
    const cartoLight = L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
      maxZoom: 20,
      attribution: "&copy; OpenStreetMap contributors & Carto"
    });
    const map = L.map("map", { zoomSnap: 0.5, layers: [cartoLight] }).setView([52.23, 21.01], 10);
    setTimeout(() => map.invalidateSize(), 50);
    window.addEventListener("resize", () => map.invalidateSize());

    // ===== –ò–∫–æ–Ω–∫–∏ / —Å–ª–æ–∏ =====
    const iconDot = (cls) => L.divIcon({ className: "marker", html:`<span class="dot ${cls}"></span>`, iconSize:[16,16], iconAnchor:[8,8] });
    const clusterService = L.markerClusterGroup({ disableClusteringAtZoom: 13 });
    const clusterRepair  = L.markerClusterGroup({ disableClusteringAtZoom: 13 });
    map.addLayer(clusterService); map.addLayer(clusterRepair);

    // ===== UI =====
    const elRadius = document.getElementById("radiusKm");
    const elCbService = document.getElementById("cbService");
    const elCbRepair  = document.getElementById("cbRepair");
    const elCountryInfo = document.getElementById("countryInfo");
    const elRestrictionsBody = document.getElementById("restrictionsBody");

    const radiusM = () => Math.min(300000, Math.max(5000, +elRadius.value*1000));

    function popupHTML({name, addr, phone, hours, url}) {
      let s = `<b>${name || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"}</b>`;
      if (addr) s += `<div>${addr}</div>`;
      if (phone) s += `<div>üìû ${phone}</div>`;
      if (hours) s += `<div>‚è∞ ${hours}</div>`;
      if (url)   s += `<div><a href="${url}" target="_blank" rel="noopener">–°–∞–π—Ç</a></div>`;
      return s;
    }

    function showEmptyNotice() {
      const old = document.getElementById('emptyNotice');
      if (old) old.remove();
      if (clusterService.getLayers().length === 0 && clusterRepair.getLayers().length === 0) {
        const n = document.createElement('div');
        n.id = 'emptyNotice';
        n.style.cssText = 'position:absolute;left:50%;top:78px;transform:translateX(-50%);z-index:1200;background:rgba(255,255,255,.96);border:1px solid #eee;border-radius:10px;padding:8px 10px;box-shadow:0 2px 10px rgba(0,0,0,.08);font:13px system-ui';
        n.innerHTML = '–ù–µ—Ç —Ç–æ—á–µ–∫ –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –≤ —Ç–µ–∫—É—â–µ–º —Ä–∞–¥–∏—É—Å–µ. –£–≤–µ–ª–∏—á—å—Ç–µ —Ä–∞–¥–∏—É—Å –∏–ª–∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –∫–∞—Ä—Ç—É.';
        document.body.appendChild(n);
        setTimeout(()=>n.remove(), 4000);
      }
    }

    // ====== –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã ======

    // --- Foursquare Places (v3 /places/search) ---
    async function fetchFoursquare(lat, lon, rad) {
      if (!FOURSQUARE_API_KEY || !PROVIDERS.foursquare) return [];
      const headers = { "Authorization": FOURSQUARE_API_KEY, "accept": "application/json" };
      // –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞: "truck repair" –∏ "truck service". radius –≤ –º–µ—Ç—Ä–∞—Ö, max 100000
      const queries = ["truck repair", "truck service", "HGV repair", "TIR"];
      const results = [];
      for (const q of queries) {
        const url = new URL("https://api.foursquare.com/v3/places/search");
        url.searchParams.set("ll", `${lat},${lon}`);
        url.searchParams.set("radius", Math.min(rad, 100000));
        url.searchParams.set("limit", "50");
        url.searchParams.set("sort", "DISTANCE");
        url.searchParams.set("query", q);
        url.searchParams.set("fields", "fsq_id,name,geocodes,location,categories,hours,website,tel"); // hours –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ –≤—Å–µ–≥–¥–∞
        try {
          const r = await fetch(url, { headers });
          if (r.ok) {
            const j = await r.json();
            for (const p of (j.results||[])) {
              results.push({
                name: p.name,
                lat: p.geocodes?.main?.latitude,
                lon: p.geocodes?.main?.longitude,
                addr: [p.location?.address, p.location?.locality].filter(Boolean).join(", "),
                phone: p.tel || null,
                hours: p.hours?.display || null,
                url: p.website || null,
                guess: "auto" // —Ç–∏–ø –æ–ø—Ä–µ–¥–µ–ª–∏–º –Ω–∏–∂–µ
              });
            }
          }
        } catch(_) {}
      }
      return results;
    }
    // --- Geoapify Places ---
    async function fetchGeoapify(lat, lon, rad) {
      if (!GEOAPIFY_API_KEY || !PROVIDERS.geoapify) return [];
      // –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–¥ —Ä–µ–º–æ–Ω—Ç/—Å–µ—Ä–≤–∏—Å –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤; Geoapify –æ–ø–∏—Ä–∞–µ—Ç—Å—è –Ω–∞ OSM –∏ –∏–º–µ–µ—Ç –∏–µ—Ä–∞—Ä—Ö–∏—é categories
      // –í–æ–∑—å–º—ë–º —Ä–µ–º–æ–Ω—Ç –∞–≤—Ç–æ + —à–∏–Ω—ã + —Å–µ—Ä–≤–∏—Å —à–∏—Ä–µ, –∞ –∑–∞—Ç–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
      const categories = [
        "service.vehicle", "service.vehicle.repair", "service.vehicle.tire"
      ].join(",");
      const url = new URL("https://api.geoapify.com/v2/places");
      url.searchParams.set("categories", categories);
      url.searchParams.set("filter", `circle:${lon},${lat},${Math.min(rad, 100000)}`);
      url.searchParams.set("bias", `proximity:${lon},${lat}`);
      url.searchParams.set("limit", "200");
      url.searchParams.set("apiKey", GEOAPIFY_API_KEY);
      url.searchParams.set("lang", "ru");
      try {
        const r = await fetch(url);
        if (!r.ok) return [];
        const j = await r.json();
        return (j.features||[]).map(f => ({
          name: f.properties?.name,
          lat: f.properties?.lat,
          lon: f.properties?.lon,
          addr: f.properties?.formatted,
          phone: f.properties?.contact?.phone || null,
          hours: f.properties?.opening_hours || null,
          url: f.properties?.website || null,
          // –ø—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞: –ø–æ –∏–º–µ–Ω–∏/–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —Å—á–∏—Ç–∞–µ–º repair/service
          guess: (String((f.properties?.categories||[]).join(",")).match(/repair|tire/i) ||
                  String(f.properties?.name||"").match(/tir|truck|hgv|ciezar|ciƒô≈ºar|wulkan|opon/i))
                  ? "repair" : "service"
        }));
      } catch(_) { return []; }
    }

    function addMarker(obj){
      if (!obj.lat || !obj.lon) return;
      // –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: –µ—Å–ª–∏ –≤ –∏–º–µ–Ω–∏/—á–∞—Å—ã/–∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö –µ—Å—Ç—å –∫–ª—é—á–∏ ‚Äî —ç—Ç–æ —Ä–µ–º–æ–Ω—Ç
      const repairHit = /repair|tire|wulkan|opon|—à–∏–Ω—ã|—Å–µ—Ä–≤–∏—Å\s*tir|truck/i.test(
        [obj.guess, obj.name, obj.hours].filter(Boolean).join(" ")
      );
      const icon = repairHit ? iconDot("repair") : iconDot("service");
      const layer = repairHit ? clusterRepair : clusterService;
      const m = L.marker([obj.lat, obj.lon], { icon }).bindPopup(
        popupHTML({ name: obj.name, addr: obj.addr, phone: obj.phone, hours: obj.hours, url: obj.url })
      );
      layer.addLayer(m);
    }

    async function loadExternalProviders(lat, lon, rad) {
      const batches = await Promise.all([
        fetchFoursquare(lat, lon, rad),
        fetchGeoapify(lat, lon, rad)
      ]);
      const merged = [].concat(...batches);
      // —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —á–µ–∫–±–æ–∫—Å–∞–º
      merged.forEach(o=>{
        const repairHit = /repair|tire|wulkan|opon|—à–∏–Ω—ã|—Å–µ—Ä–≤–∏—Å\s*tir|truck/i.test(
          [o.guess, o.name, o.hours].filter(Boolean).join(" ")
        );
        if (repairHit && !elCbRepair.checked) return;
        if (!repairHit && !elCbService.checked) return;
        addMarker(o);
      });
    }

    // ===== Trafficban-–∑–∞–≥–ª—É—à–∫–∞ (–æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ –µ—Å—Ç—å) =====
    const TRAFFICBAN_API_KEY = "";
    async function getCountryByLatLon(lat,lon){
      try{
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
        const j = await r.json();
        return { country: j?.address?.country || "", cc: j?.address?.country_code?.toUpperCase() || "" };
      } catch { return { country:"", cc:"" }; }
    }
    async function loadTrafficBans(lat,lon){
      elRestrictionsBody.innerHTML = `<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π‚Ä¶</div>`;
      const { country } = await getCountryByLatLon(lat,lon);
      document.getElementById("countryInfo").textContent = country ? `‚Äî ${country}` : "";
      if(!TRAFFICBAN_API_KEY){
        elRestrictionsBody.innerHTML = `<div class="muted">–í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á Trafficban API, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ —Å—Ç—Ä–∞–Ω–µ.</div>`;
        return;
      }
      // –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ trafficban.com
    }

    // ===== –û–±—â–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ =====
    async function loadAll(lat,lon){
      clusterService.clearLayers();
      clusterRepair.clearLayers();
      const rad = radiusM();
      await loadExternalProviders(lat, lon, rad);
      await loadTrafficBans(lat,lon);
      if (!elCbService.checked) clusterService.clearLayers();
      if (!elCbRepair.checked)  clusterRepair.clearLayers();
      showEmptyNotice();
    }

    // ===== –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è/–∫–Ω–æ–ø–∫–∏ =====
    async function locateUser(){
      if(!navigator.geolocation) return null;
      return new Promise(res=>{
        navigator.geolocation.getCurrentPosition(
          pos=>res({lat:pos.coords.latitude, lon:pos.coords.longitude}),
          ()=>res(null),
          { enableHighAccuracy:true, timeout:8000 }
        );
      });
    }
    document.getElementById("btnLocate").onclick = async ()=>{
      const loc = await locateUser();
      if(loc){ map.setView([loc.lat, loc.lon], 11); await loadAll(loc.lat, loc.lon); }
      else alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é");
    };
    document.getElementById("btnReload").onclick = async ()=>{
      const c = map.getCenter(); await loadAll(c.lat, c.lng);
    };
    [elCbService, elCbRepair].forEach(cb=>{
      cb.addEventListener("change", async ()=>{
        const c = map.getCenter();
        await loadAll(c.lat, c.lng);
      });
    });
    document.getElementById("radiusKm").addEventListener("change", async ()=>{
      const c = map.getCenter(); await loadAll(c.lat, c.lng);
    });

    // –ø–æ–¥—Ç—è–≥–∏–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏ —Å–º–µ—â–µ–Ω–∏–∏ —Ü–µ–Ω—Ç—Ä–∞
    let tbTimer=null;
    map.on("moveend", ()=>{
      if(tbTimer) clearTimeout(tbTimer);
      tbTimer = setTimeout(async ()=>{
        const c = map.getCenter(); await loadTrafficBans(c.lat, c.lng);
      }, 600);
    });

    // ===== –°—Ç–∞—Ä—Ç =====
    (async ()=>{
      const c = map.getCenter();
      await loadAll(c.lat, c.lng);
    })();
  </script>
</body>
</html>
